<!DOCTYPE html>
<html lang="en" class="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>InCheck Issues Dashboard</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: { inter: ["Inter", "sans-serif"] },
          colors: {
            accent: "#4f8cff",
            danger: "#ef4444",
            ok: "#10b981",
            warn: "#f59e0b",
            info: "#3b82f6",
            purple: "#8b5cf6",
            neutral: "#6b7280"
          }
        }
      }
    }
  </script>

  <!-- Fonts & Libs -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
</head>

<body class="bg-gray-950 text-gray-100 font-inter transition-colors duration-300">

  <!-- Header -->
  <header class="sticky top-0 z-50 bg-gray-900/80 backdrop-blur border-b border-gray-800 shadow-md">
    <div class="max-w-7xl mx-auto flex flex-wrap items-center gap-4 px-4 py-3">
      <h1 class="font-bold text-xl">InCheck Issues Dashboard</h1>
      <div class="ml-auto flex flex-wrap gap-3 items-end text-sm">
        <input id="searchInput" type="search" placeholder="Search issues..."
          class="rounded-xl px-3 py-2 bg-gray-800 border border-gray-700 focus:ring-2 focus:ring-accent outline-none" />
        <select id="moduleFilter" class="rounded-xl px-3 py-2 bg-gray-800 border border-gray-700"></select>
        <select id="priorityFilter" class="rounded-xl px-3 py-2 bg-gray-800 border border-gray-700"></select>
        <select id="statusFilter" class="rounded-xl px-3 py-2 bg-gray-800 border border-gray-700"></select>
        <input type="date" id="startDateFilter"
          class="rounded-xl px-3 py-2 bg-gray-800 border border-gray-700" />
        <input type="date" id="endDateFilter"
          class="rounded-xl px-3 py-2 bg-gray-800 border border-gray-700" />
        <button id="refreshNow"
          class="px-4 py-2 rounded-lg bg-accent hover:bg-blue-500 font-semibold">Refresh</button>
        <button id="resetBtn"
          class="px-4 py-2 rounded-lg bg-gray-700 hover:bg-gray-600 font-semibold">Reset</button>
        <a href="https://docs.google.com/forms/d/e/1FAIpQLScZBcjXHMzssdXADWcmBiQKurxxR6eHQ_qR7-JdDoUbZg78lw/viewform"
           target="_blank"
           class="px-4 py-2 rounded-lg bg-green-600 hover:bg-green-500 font-semibold">➕ New Ticket</a>
        <button id="themeToggle"
          class="px-3 py-2 rounded-lg bg-gray-800 hover:bg-gray-700">🌙</button>
      </div>
    </div>
  </header>

  <!-- Content -->
  <main class="max-w-7xl mx-auto px-4 py-6 space-y-6">

    <!-- KPI Cards -->
    <div id="kpis" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4"></div>

    <!-- Charts -->
    <div class="grid md:grid-cols-2 gap-4">
      <div class="bg-gray-900 rounded-2xl p-4 shadow"><canvas id="byModule"></canvas></div>
      <div class="bg-gray-900 rounded-2xl p-4 shadow"><canvas id="byPriority"></canvas></div>
      <div class="bg-gray-900 rounded-2xl p-4 shadow"><canvas id="byStatus"></canvas></div>
      <div class="bg-gray-900 rounded-2xl p-4 shadow"><canvas id="byType"></canvas></div>
    </div>

    <!-- Issues Table -->
    <div class="bg-gray-900 rounded-2xl p-6 shadow space-y-4">
      <div class="flex justify-between items-center">
        <strong class="text-lg">Issues</strong>
        <span id="rowCount" class="text-sm text-gray-400"></span>
      </div>
      <div class="overflow-auto max-h-[500px] rounded-xl border border-gray-800">
        <table id="issuesTable" class="w-full text-sm">
          <thead class="sticky top-0 bg-gray-800/80 backdrop-blur">
            <tr class="text-left">
              <th class="px-4 py-2">ID</th>
              <th class="px-4 py-2">Module</th>
              <th class="px-4 py-2">Title</th>
              <th class="px-4 py-2">Priority</th>
              <th class="px-4 py-2">Status</th>
              <th class="px-4 py-2">Date</th>
              <th class="px-4 py-2">Log</th>
              <th class="px-4 py-2">Link</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-gray-800"></tbody>
        </table>
      </div>
    </div>
  </main>

  <!-- Modal -->
  <div id="issueModal"
       class="fixed inset-0 hidden bg-black/70 backdrop-blur-sm items-center justify-center z-50">
    <div class="bg-gray-900 rounded-2xl shadow-xl max-w-2xl w-11/12 p-6 relative">
      <button onclick="closeModal()" class="absolute top-3 right-3 text-gray-400 hover:text-white">✖</button>
      <div id="modalBody" class="space-y-2"></div>
    </div>
  </div>

  <!-- Logic -->
  <script>
    const SHEET_URL="https://docs.google.com/spreadsheets/d/e/2PACX-1vTRwAjNAQxiPP8uR15t_vx03JkjgEBjgUwp2bpx8rsHx-JJxVDBZyf5ap77rAKrYHfgkVMwLJVm6pGn/pub?output=csv";
    const els={tableBody:document.querySelector('#issuesTable tbody'),
      rowCount:document.getElementById('rowCount'),
      moduleFilter:document.getElementById('moduleFilter'),
      priorityFilter:document.getElementById('priorityFilter'),
      statusFilter:document.getElementById('statusFilter'),
      reset:document.getElementById('resetBtn'),
      refresh:document.getElementById('refreshNow'),
      kpis:document.getElementById('kpis'),
      modal:document.getElementById('issueModal'),
      modalBody:document.getElementById('modalBody')};
    let rows=[],filtered=[],charts={};

    function normalizeRow(raw){
      const lower={}; for(const k in raw){
        if(!k) continue;
        const cleanKey=k.toLowerCase().replace(/\s+/g,' ').trim();
        lower[cleanKey]=String(raw[k]??'').trim();
      }
      const pick=(...keys)=>{ for(const key of keys){ if(lower[key]) return lower[key]; } return ''; };
      return {
        id: pick('ticket id','id'),
        module: pick('impacted module','module','issue location')||'Unspecified',
        title: pick('title'),
        desc: pick('description'),
        file: pick('file upload','link','url'),
        priority: pick('priority'),
        status: pick('status')||'Not Started Yet',
        type: pick('category','type'),
        date: pick('timestamp','date','created at'),
        log: pick('log','logs','comment','notes')
      };
    }

    function parseCsv(t){
      return Papa.parse(t,{header:true,skipEmptyLines:true}).data
        .map(normalizeRow)
        .filter(r=>r.id||r.title||r.module);
    }

    function badge(text,type){
      const colors={
        High:"bg-red-500 text-white",
        Medium:"bg-yellow-400 text-black",
        Low:"bg-green-400 text-black",
        Resolved:"bg-emerald-600 text-white",
        "Under Development":"bg-blue-600 text-white",
        Rejected:"bg-red-600 text-white",
        "On Hold":"bg-amber-500 text-black",
        "Not Started Yet":"bg-gray-600 text-white",
        Sent:"bg-purple-600 text-white"
      };
      return `<span class="px-2 py-1 rounded-lg text-xs font-semibold ${colors[text]||"bg-gray-700 text-white"}">${text||"-"}</span>`;
    }

    function renderKpis(){
      const total=filtered.length; const counts={};
      filtered.forEach(r=>{counts[r.status]=(counts[r.status]||0)+1;});
      els.kpis.innerHTML='';
      const add=(label,val)=>{const d=document.createElement('div');
        d.className='bg-gray-900 rounded-2xl p-6 shadow text-center cursor-pointer hover:scale-[1.02] transition';
        d.innerHTML=`<div class="text-sm text-gray-400 uppercase">${label}</div><div class="text-2xl font-bold mt-1">${val}</div>`;
        d.onclick=()=>{els.statusFilter.value=label;applyFilters();};
        els.kpis.appendChild(d);};
      add('Total Issues',total); Object.entries(counts).forEach(([s,v])=>add(s,v));
    }

    function renderFilters(){
      const uniq=(arr)=>[...new Set(arr.filter(Boolean).map(v=>v.trim()))].sort((a,b)=>a.localeCompare(b));
      els.moduleFilter.innerHTML=['All',...uniq(rows.map(r=>r.module))].map(v=>`<option>${v}</option>`).join('');
      els.priorityFilter.innerHTML=['All',...uniq(rows.map(r=>r.priority))].map(v=>`<option>${v}</option>`).join('');
      els.statusFilter.innerHTML=['All',...uniq(rows.map(r=>r.status))].map(v=>`<option>${v}</option>`).join('');
    }

    function renderTable(){
      els.tableBody.innerHTML=filtered.map(r=>`
        <tr onclick="openModal('${r.id}')" class="hover:bg-gray-800/50 cursor-pointer transition">
          <td class="px-4 py-2">${r.id||'-'}</td>
          <td class="px-4 py-2">${r.module}</td>
          <td class="px-4 py-2">${r.title||'-'}</td>
          <td class="px-4 py-2">${badge(r.priority)}</td>
          <td class="px-4 py-2">${badge(r.status)}</td>
          <td class="px-4 py-2">${r.date||'-'}</td>
          <td class="px-4 py-2">${r.log||'-'}</td>
          <td class="px-4 py-2">${r.file?`<a href="${r.file}" target="_blank">🔗</a>`:'-'}</td>
        </tr>`).join('');
      els.rowCount.textContent=`${filtered.length} rows`;
    }

    function groupCount(list,key){return list.reduce((a,r)=>{const k=r[key]||'Unspecified';a[k]=(a[k]||0)+1;return a;},{});}
    function drawCharts(){
      const make=(id,type,data)=>{if(charts[id])charts[id].destroy();
        charts[id]=new Chart(document.getElementById(id),{type,data:{labels:Object.keys(data),datasets:[{data:Object.values(data)}]},options:{plugins:{legend:{display:type!=='bar'}}}});}
      make('byModule','bar',groupCount(filtered,'module'));
      make('byPriority','doughnut',groupCount(filtered,'priority'));
      make('byStatus','bar',groupCount(filtered,'status'));
      make('byType','bar',groupCount(filtered,'type'));
    }

    function applyFilters(){
      const q=(document.getElementById('searchInput').value||'').toLowerCase();
      const m=els.moduleFilter.value,p=els.priorityFilter.value,s=els.statusFilter.value;
      const start=document.getElementById('startDateFilter').value;
      const end=document.getElementById('endDateFilter').value;
      const startDate=start?new Date(start):null;
      const endDate=end?(()=>{let d=new Date(end);d.setDate(d.getDate()+1);return d;})():null;
      filtered=rows.filter(r=>{
        const hay=(r.id+' '+r.module+' '+(r.title||'')+' '+(r.desc||'')+' '+(r.log||'')).toLowerCase();
        let keepDate=true;
        if(r.date){const d=new Date(r.date);if(startDate&&d<startDate)keepDate=false;if(endDate&&d>=endDate)keepDate=false;}
        else if(startDate||endDate) keepDate=false;
        return (!q||hay.includes(q))&&(!m||m==='All'||r.module===m)&&(!p||p==='All'||r.priority===p)&&(!s||s==='All'||r.status===s)&&keepDate;});
      renderKpis();renderTable();drawCharts();
    }

    async function loadSheet(){try{const res=await fetch(SHEET_URL);const text=await res.text();rows=parseCsv(text);filtered=[...rows];renderFilters();applyFilters();}catch(e){alert("Error loading data: "+e.message);}}
    function openModal(id){const r=rows.find(x=>x.id===id);
      els.modalBody.innerHTML=`
        <h2 class="text-xl font-bold mb-2">${r.title||'-'}</h2>
        <p><b>ID:</b> ${r.id||'-'}</p>
        <p><b>Module:</b> ${r.module}</p>
        <p><b>Priority:</b> ${r.priority||'-'}</p>
        <p><b>Status:</b> ${r.status||'-'}</p>
        <p><b>Date:</b> ${r.date||'-'}</p>
        <p><b>Description:</b> ${r.desc||'-'}</p>
        <p><b>Log:</b> ${r.log||'-'}</p>
        ${r.file?`<p><b>Attachment:</b> <a href="${r.file}" target="_blank" class="text-accent underline">${r.file}</a></p>`:''}`;
      els.modal.classList.remove('hidden');els.modal.classList.add('flex');}
    function closeModal(){els.modal.classList.add('hidden');els.modal.classList.remove('flex');}

    document.getElementById('searchInput').addEventListener('input',applyFilters);
    els.moduleFilter.addEventListener('change',applyFilters);
    els.priorityFilter.addEventListener('change',applyFilters);
    els.statusFilter.addEventListener('change',applyFilters);
    document.getElementById('startDateFilter').addEventListener('change',applyFilters);
    document.getElementById('endDateFilter').addEventListener('change',applyFilters);
    els.reset.onclick=()=>{document.getElementById('searchInput').value='';document.getElementById('startDateFilter').value='';document.getElementById('endDateFilter').value='';renderFilters();applyFilters();};
    els.refresh.onclick=loadSheet;
    loadSheet();

    const themeBtn=document.getElementById('themeToggle');
    if(localStorage.getItem('theme')){document.documentElement.classList.toggle('dark',localStorage.getItem('theme')==='dark');themeBtn.textContent=localStorage.getItem('theme')==='light'?'🌙':'☀️';}
    themeBtn.addEventListener('click',()=>{const isDark=document.documentElement.classList.contains('dark');document.documentElement.classList.toggle('dark',!isDark);localStorage.setItem('theme',isDark?'light':'dark');themeBtn.textContent=isDark?'🌙':'☀️';});
  </script>
</body>
</html>
