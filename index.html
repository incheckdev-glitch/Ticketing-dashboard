<script>
  const SHEET_URL="https://docs.google.com/spreadsheets/d/e/2PACX-1vTRwAjNAQxiPP8uR15t_vx03JkjgEBjgUwp2bpx8rsHx-JJxVDBZyf5ap77rAKrYHfgkVMwLJVm6pGn/pub?output=csv";
  const els={
    tableBody:document.querySelector('#issuesTable tbody'),
    rowCount:document.getElementById('rowCount'),
    moduleFilter:document.getElementById('moduleFilter'),
    priorityFilter:document.getElementById('priorityFilter'),
    statusFilter:document.getElementById('statusFilter'),
    reset:document.getElementById('resetBtn'),
    refresh:document.getElementById('refreshNow'),
    kpis:document.getElementById('kpis'),
    modal:document.getElementById('issueModal'),
    modalBody:document.getElementById('modalBody'),
    toolbar:document.querySelector('.toolbar')
  };
  let rows=[],filtered=[],charts={},sortKey=null,sortAsc=true;
  let currentPage=1,rowsPerPage=20;

  // --- Normalize ---
  function normalizeRow(raw){
    const lower={};
    for(const k in raw){ if(!k) continue; lower[k.toLowerCase().trim()]=String(raw[k]??'').trim(); }
    const pick=(...keys)=>keys.map(k=>lower[k]).find(Boolean)||'';
    return {
      id:pick('ticket id','id'),
      module:pick('impacted module','module','issue location')||'Unspecified',
      title:pick('title'),
      desc:pick('description'),
      file:pick('file upload','link','url'),
      priority:pick('priority'),
      status:pick('status')||'Not Started Yet',
      type:pick('category','type'),
      date:pick('timestamp','date','created at'),
      log:pick('log','logs','comment','notes')
    };
  }

  // --- CSV ---
  function parseCsv(t){
    return Papa.parse(t,{header:true,skipEmptyLines:true}).data
      .map(normalizeRow)
      .filter(r=>r.id||r.title||r.module);
  }

  // --- Helpers ---
  function pill(text,cls){return `<span class="pill ${cls}">${text||'-'}</span>`;}
  function statusBadge(s){return pill(s,`status-${s.replace(/\s/g,'\\ ')}`);}
  function priorityBadge(p){return pill(p,`priority-${p}`);}

  // --- KPIs ---
  function renderKpis(){
    const total=filtered.length; const counts={};
    filtered.forEach(r=>counts[r.status]=(counts[r.status]||0)+1);
    els.kpis.innerHTML='';
    const add=(label,val)=>{
      const d=document.createElement('div');
      d.className='card kpi'; d.setAttribute("tabindex","0");
      d.innerHTML=`<div class="label">${label}</div><div class="value">${val}</div>`;
      d.onclick=()=>{ if(label!=="Total Issues"){els.statusFilter.value=label;applyFilters();} };
      els.kpis.appendChild(d);
    };
    add('Total Issues',total);
    Object.entries(counts).forEach(([s,v])=>add(s,v));
  }

  // --- Filters ---
  function renderFilters(){
    const uniq=(arr)=>[...new Set(arr.filter(Boolean).map(v=>v.trim()))].sort();
    els.moduleFilter.innerHTML=['All',...uniq(rows.map(r=>r.module))].map(v=>`<option>${v}</option>`).join('');
    els.priorityFilter.innerHTML=['All',...uniq(rows.map(r=>r.priority))].map(v=>`<option>${v}</option>`).join('');
    els.statusFilter.innerHTML=['All',...uniq(rows.map(r=>r.status))].map(v=>`<option>${v}</option>`).join('');
  }

  // --- Sorting ---
  function sortData(list){
    if(!sortKey) return list;
    return [...list].sort((a,b)=>{
      const va=a[sortKey]||"", vb=b[sortKey]||"";
      if(sortKey==="date"){ return (new Date(va)-new Date(vb))*(sortAsc?1:-1); }
      return va.localeCompare(vb)*(sortAsc?1:-1);
    });
  }

  // --- Pagination ---
  function paginate(list){
    const start=(currentPage-1)*rowsPerPage;
    return list.slice(start,start+rowsPerPage);
  }

  // --- Table ---
  function renderTable(){
    let list=sortData(filtered);
    const pageData=paginate(list);
    els.tableBody.innerHTML=pageData.map(r=>`
      <tr onclick="openModal('${r.id}')" tabindex="0">
        <td>${r.id||'-'}</td>
        <td>${r.module}</td>
        <td>${r.title||'-'}</td>
        <td>${priorityBadge(r.priority)}</td>
        <td>${statusBadge(r.status)}</td>
        <td>${r.date||'-'}</td>
        <td>${r.log||'-'}</td>
        <td>${r.file?`<a href="${r.file}" target="_blank">üîó</a>`:'-'}</td>
      </tr>`).join('');
    els.rowCount.textContent=`${filtered.length} rows (page ${currentPage}/${Math.ceil(filtered.length/rowsPerPage)})`;
  }

  // --- Charts ---
  function groupCount(list,key){return list.reduce((a,r)=>{const k=r[key]||'Unspecified';a[k]=(a[k]||0)+1;return a;},{});}
  function drawCharts(){
    const colors={High:"#f87171",Medium:"#fbbf24",Low:"#34d399"};
    const make=(id,type,data)=>{
      if(charts[id])charts[id].destroy();
      charts[id]=new Chart(document.getElementById(id),{
        type,
        data:{labels:Object.keys(data),datasets:[{data:Object.values(data),backgroundColor:Object.keys(data).map(k=>colors[k]||'#4f8cff')}]},
        options:{plugins:{legend:{display:type!=='bar'}}}
      });
    };
    make('byModule','bar',groupCount(filtered,'module'));
    make('byPriority','doughnut',groupCount(filtered,'priority'));
    make('byStatus','bar',groupCount(filtered,'status'));
    make('byType','bar',groupCount(filtered,'type'));
  }

  // --- Filters Apply ---
  function applyFilters(){
    const q=(document.getElementById('searchInput').value||'').toLowerCase();
    const m=els.moduleFilter.value,p=els.priorityFilter.value,s=els.statusFilter.value;
    const start=document.getElementById('startDateFilter').value;
    const end=document.getElementById('endDateFilter').value;
    const startDate=start?new Date(start):null;
    const endDate=end?(()=>{let d=new Date(end);d.setDate(d.getDate()+1);return d;})():null;
    filtered=rows.filter(r=>{
      const hay=(r.id+' '+r.module+' '+(r.title||'')+' '+(r.desc||'')+' '+(r.log||'')).toLowerCase();
      let keepDate=true;
      if(r.date){
        const d=new Date(r.date);
        if(!isNaN(d)){
          if(startDate&&d<startDate) keepDate=false;
          if(endDate&&d>=endDate) keepDate=false;
        }
      } else if(startDate||endDate) keepDate=false;
      return (!q||hay.includes(q))&&(!m||m==='All'||r.module===m)&&(!p||p==='All'||r.priority===p)&&(!s||s==='All'||r.status===s)&&keepDate;
    });
    currentPage=1;
    renderKpis();renderTable();drawCharts();
  }

  // --- Export ---
  function exportCsv(){
    const csv=Papa.unparse(filtered);
    const blob=new Blob([csv],{type:"text/csv"});
    const url=URL.createObjectURL(blob);
    const a=document.createElement("a");
    a.href=url; a.download="issues_export.csv"; a.click();
    URL.revokeObjectURL(url);
  }

  // --- Load sheet ---
  async function loadSheet(){
    try{
      const res=await fetch(SHEET_URL);
      if(!res.ok) throw new Error("Failed to fetch");
      const text=await res.text();
      rows=parseCsv(text); filtered=[...rows];
      renderFilters();applyFilters();
    }catch(e){
      els.tableBody.innerHTML=`<tr><td colspan="8" style="color:red">Error loading data: ${e.message}</td></tr>`;
    }
  }

  // --- Modal ---
  function openModal(id){
    const r=rows.find(x=>x.id===id);
    if(!r) return;
    els.modalBody.innerHTML=`
      <h2>${r.title||'-'}</h2>
      <p><b>ID:</b> ${r.id||'-'}</p>
      <p><b>Module:</b> ${r.module}</p>
      <p><b>Priority:</b> ${r.priority||'-'}</p>
      <p><b>Status:</b> ${r.status||'-'}</p>
      <p><b>Date:</b> ${r.date||'-'}</p>
      <p><b>Description:</b> ${r.desc||'-'}</p>
      <p><b>Log:</b> ${r.log||'-'}</p>
      ${r.file?`<p><b>Attachment:</b> <a href="${r.file}" target="_blank">${r.file}</a></p>`:''}`;
    els.modal.style.display='flex';
  }
  function closeModal(){els.modal.style.display='none';}

  // --- Event Listeners ---
  document.getElementById('searchInput').addEventListener('input',applyFilters);
  els.moduleFilter.addEventListener('change',applyFilters);
  els.priorityFilter.addEventListener('change',applyFilters);
  els.statusFilter.addEventListener('change',applyFilters);
  document.getElementById('startDateFilter').addEventListener('change',applyFilters);
  document.getElementById('endDateFilter').addEventListener('change',applyFilters);
  els.reset.onclick=()=>{document.getElementById('searchInput').value='';document.getElementById('startDateFilter').value='';document.getElementById('endDateFilter').value='';renderFilters();applyFilters();};
  els.refresh.onclick=loadSheet;

  // Sorting headers (safe mapping)
  const headerMap={
    "ID":"id","Module":"module","Title":"title","Priority":"priority","Status":"status","Date":"date","Log":"log"
  };
  document.querySelectorAll("#issuesTable th").forEach(th=>{
    th.style.cursor="pointer";
    th.onclick=()=>{
      const key=headerMap[th.textContent.trim()];
      if(!key) return;
      if(sortKey===key) sortAsc=!sortAsc; else{sortKey=key;sortAsc=true;}
      renderTable();
    };
  });

  // Export button
  const exportBtn=document.createElement("button");
  exportBtn.textContent="‚¨á Export CSV"; exportBtn.onclick=exportCsv;
  els.toolbar.appendChild(exportBtn);

  // Theme toggle
  const themeBtn=document.getElementById('themeToggle');
  if(localStorage.getItem('theme')){
    document.documentElement.setAttribute('data-theme',localStorage.getItem('theme'));
    themeBtn.textContent=localStorage.getItem('theme')==='light'?'üåô':'‚òÄÔ∏è';
  }
  themeBtn.addEventListener('click',()=>{
    const cur=document.documentElement.getAttribute('data-theme')||'dark';
    const next=cur==='dark'?'light':'dark';
    document.documentElement.setAttribute('data-theme',next);
    localStorage.setItem('theme',next);
    themeBtn.textContent=next==='light'?'üåô':'‚òÄÔ∏è';
  });

  loadSheet();
</script>
