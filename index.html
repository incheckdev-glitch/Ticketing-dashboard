<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>InCheck Issues Dashboard</title>

  <!-- Libs -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    :root {
      --bg:#0b1020; --card:#0f1630; --muted:#9aa6d1; --text:#e8edff;
      --accent:#4f8cff; --danger:#ef4444; --ok:#10b981; --warn:#f59e0b;
      --info:#3b82f6; --purple:#8b5cf6; --neutral:#6b7280; --border:#1e2643;
      --shadow:0 8px 24px rgba(0,0,0,.35);
    }
    :root[data-theme="light"] {
      --bg:#f4f6ff; --card:#ffffff; --muted:#5a678c; --text:#0d1326;
      --accent:#2563eb; --danger:#dc2626; --ok:#059669; --warn:#d97706;
      --info:#1d4ed8; --purple:#7c3aed; --neutral:#374151; --border:#e7eaf6;
      --shadow:0 10px 24px rgba(16,24,40,.08);
    }
    * { box-sizing:border-box }
    html,body { height:100% }
    body {
      margin:0; font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;
      background:var(--bg); color:var(--text); transition:background .3s,color .3s;
    }
    header {
      position:sticky; top:0; z-index:20; background:var(--card);
      border-bottom:1px solid var(--border);
      display:flex; align-items:center; gap:12px; padding:10px 16px;
      box-shadow:var(--shadow);
    }
    .brand { display:flex; align-items:center; gap:10px; font-weight:700; }
    .brand .logo {
      width:28px; height:28px; border-radius:8px; display:grid; place-items:center;
      background:linear-gradient(135deg,var(--accent),#9b8cff);
      color:#fff; font-weight:800; box-shadow:0 6px 18px rgba(79,140,255,.35);
    }
    .toolbar { margin-left:auto; display:flex; gap:10px; align-items:center; flex-wrap:wrap }
    .btn, .select, .input {
      padding:8px 12px; border-radius:10px; border:1px solid var(--border);
      background:transparent; color:inherit; font:inherit;
    }
    .btn { cursor:pointer; font-weight:600; background:var(--card) }
    .btn.primary { background:var(--accent); border-color:transparent; color:#fff }
    .btn.ghost { border-color:transparent; background:transparent }
    .btn:hover { opacity:.92; transform:translateY(-1px) }
    .icon { font-size:18px; line-height:1 }
    .wrap { display:grid; grid-template-columns:280px 1fr; gap:18px; padding:18px; max-width:1400px; margin:0 auto }
    @media(max-width:980px){ .wrap { grid-template-columns:1fr } }
    .sidebar {
      background:var(--card); border:1px solid var(--border); border-radius:14px; padding:16px;
      position:sticky; top:76px; height:fit-content; max-height:calc(100vh - 96px); overflow:auto;
    }
    .sidebar h3 { margin:0 0 10px 0; font-size:14px; color:var(--muted); text-transform:uppercase; letter-spacing:.06em }
    .filter-group { display:grid; gap:10px; margin-bottom:16px }
    .filter-row { display:grid; gap:8px }
    .muted { color:var(--muted); font-size:12px }
    .divider { height:1px; background:var(--border); margin:8px 0 14px }
    .content { display:grid; gap:18px }
    .grid { display:grid; gap:16px }
    .grid.cols-4 { grid-template-columns:repeat(4,1fr) }
    @media(max-width:980px){ .grid.cols-4{ grid-template-columns:repeat(2,1fr) } }
    @media(max-width:600px){ .grid.cols-4{ grid-template-columns:1fr } }
    .card {
      background:var(--card); border:1px solid var(--border); border-radius:14px; padding:16px;
      box-shadow:var(--shadow); transition:transform .2s, box-shadow .2s;
    }
    .card:hover { transform:translateY(-2px) }
    .kpi { cursor:pointer; text-align:center; }
    .kpi .label { font-size:12px; color:var(--muted); text-transform:uppercase }
    .kpi .value { font-size:26px; font-weight:800; margin-top:6px }
    .kpi:hover { box-shadow:0 8px 26px rgba(79,140,255,.15) }
    .charts { display:grid; grid-template-columns:repeat(2,1fr); gap:16px }
    @media(max-width:980px){ .charts{ grid-template-columns:1fr } }
    table { width:100%; border-collapse:separate; border-spacing:0; font-size:14px }
    thead th {
      position:sticky; top:0; background:var(--card); text-align:left; padding:12px 10px;
      border-bottom:1px solid var(--border); user-select:none; cursor:pointer;
    }
    tbody td { padding:11px 10px; border-bottom:1px solid var(--border) }
    tr:hover { background:rgba(255,255,255,.03) }
    .table-wrap { max-height:460px; overflow:auto; border-radius:10px; border:1px solid var(--border) }
    th.sortable::after { content:" â‡…"; color:var(--muted); font-size:12px }
    th.sorted-asc::after { content:" â†‘" }
    th.sorted-desc::after { content:" â†“" }
    .pill { padding:2px 8px; border-radius:12px; font-size:12px; font-weight:700; display:inline-block }
    .status-Resolved{background:var(--ok);color:#fff}
    .status-Under\ Development{background:var(--info);color:#fff}
    .status-Rejected{background:var(--danger);color:#fff}
    .status-On\ Hold{background:var(--warn);color:#000}
    .status-Not\ Started\ Yet{background:var(--neutral);color:#fff}
    .status-Sent{background:var(--purple);color:#fff}
    .priority-High{background:#f87171;color:#fff}
    .priority-Medium{background:#fbbf24;color:#000}
    .priority-Low{background:#34d399;color:#000}
    .modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,.55); align-items:center; justify-content:center; z-index:100 }
    .modal-content { background:var(--card); color:var(--text); border:1px solid var(--border);
      padding:18px; border-radius:14px; max-width:760px; width:92%; max-height:90%; overflow:auto; box-shadow:var(--shadow) }
    .modal .header { display:flex; align-items:center; gap:10px; justify-content:space-between; margin-bottom:8px }
    .modal .actions { display:flex; gap:8px }
    .modal-close { cursor:pointer; border:none; background:transparent; color:var(--muted); font-size:20px }
    .table-actions { display:flex; gap:10px; align-items:center; justify-content:space-between; margin-top:10px; flex-wrap:wrap }
    .pagination { display:flex; gap:6px; align-items:center }
    .chip { padding:6px 10px; border-radius:8px; background:var(--card); border:1px solid var(--border); cursor:pointer }
    .chip.active { background:var(--accent); color:#fff; border-color:transparent }
    .select.sm, .input.sm { padding:6px 8px; border-radius:8px; font-size:13px }
    .drawer-toggle { display:none }
    @media(max-width:980px){
      .drawer-toggle { display:inline-flex }
      .sidebar { position:fixed; inset:76px 0 0 auto; width:88%; max-width:360px; transform:translateX(110%); transition:transform .25s }
      .sidebar.open { transform:translateX(0) }
    }
    .spinner { display:none; position:fixed; inset:0; background:rgba(0,0,0,.35); z-index:120; align-items:center; justify-content:center }
    .spinner .ring { width:54px; height:54px; border:5px solid var(--border); border-top-color:var(--accent); border-radius:50%; animation:spin 1s linear infinite; background:transparent }
    @keyframes spin { to { transform:rotate(360deg) } }
    .toast { position:fixed; right:16px; bottom:16px; background:var(--card); border:1px solid var(--danger); color:#fff;
      padding:10px 12px; border-radius:10px; z-index:130; box-shadow:var(--shadow); display:none }
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <div class="logo">IC</div>
      <div>InCheck Issues</div>
    </div>

    <button id="drawerBtn" class="btn drawer-toggle"><span class="icon">ðŸ§°</span> Filters</button>

    <div class="toolbar">
      <input id="searchInput" class="input" type="search" placeholder="Search ID, title, description, logâ€¦" />
      <select id="themeSelect" class="select">
        <option value="system">System</option>
        <option value="dark">Dark</option>
        <option value="light">Light</option>
      </select>
      <button id="refreshNow" class="btn"><span class="icon">ðŸ”„</span> Refresh</button>
      <button id="exportBtn" class="btn"><span class="icon">â¬‡</span> Export CSV</button>
      <button id="newTicketBtn" class="btn primary"><span class="icon">âž•</span> New Ticket</button>
    </div>
  </header>

  <!-- Main Layout -->
  <div class="wrap">
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
      <h3>Filters</h3>
      <div class="filter-group">
        <div class="filter-row">
          <label class="muted">Module</label>
          <select id="moduleFilter" class="select"></select>
        </div>
        <div class="filter-row">
          <label class="muted">Priority</label>
          <select id="priorityFilter" class="select"></select>
        </div>
        <div class="filter-row">
          <label class="muted">Status</label>
          <select id="statusFilter" class="select"></select>
        </div>
      </div>
      <div class="divider"></div>
      <div class="filter-group">
        <div class="filter-row">
          <label class="muted">Start Date</label>
          <input type="date" id="startDateFilter" class="input">
        </div>
        <div class="filter-row">
          <label class="muted">End Date</label>
          <input type="date" id="endDateFilter" class="input">
        </div>
      </div>
      <div class="divider"></div>
      <div class="filter-group">
        <button id="resetBtn" class="btn ghost">Reset</button>
        <span class="muted">Tip: click any KPI to filter by that status.</span>
      </div>
    </aside>

    <!-- Content -->
    <main class="content">
      <div class="grid cols-4" id="kpis"></div>
      <div class="charts">
        <div class="card"><canvas id="byModule" height="140"></canvas></div>
        <div class="card"><canvas id="byPriority" height="140"></canvas></div>
        <div class="card"><canvas id="byStatus" height="140"></canvas></div>
        <div class="card"><canvas id="byType" height="140"></canvas></div>
      </div>
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
          <strong>Issues</strong>
          <span id="rowCount" class="muted"></span>
        </div>
        <div class="table-wrap">
          <table id="issuesTable">
            <thead><tr>
              <th data-key="id" class="sortable">ID</th>
              <th data-key="module" class="sortable">Module</th>
              <th data-key="title" class="sortable">Title</th>
              <th data-key="priority" class="sortable">Priority</th>
              <th data-key="status" class="sortable">Status</th>
              <th data-key="date" class="sortable">Date</th>
              <th data-key="log" class="sortable">Log</th>
              <th>Link</th>
            </tr></thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="table-actions">
          <div class="pagination">
            <button id="firstPage" class="chip">Â« First</button>
            <button id="prevPage" class="chip">â€¹ Prev</button>
            <span id="pageInfo" class="muted"></span>
            <button id="nextPage" class="chip">Next â€º</button>
            <button id="lastPage" class="chip">Last Â»</button>
          </div>
          <div style="display:flex;gap:8px;align-items:center">
            <span class="muted">Rows per page</span>
            <select id="pageSize" class="select sm">
              <option>10</option><option selected>20</option><option>50</option><option>100</option>
            </select>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Modal -->
  <div id="issueModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <div class="modal-content">
      <div class="header">
        <h2 id="modalTitle" style="margin:0;font-size:20px">Issue</h2>
        <div class="actions">
          <button id="copyId" class="btn sm"><span class="icon">ðŸ†”</span> Copy ID</button>
          <button id="copyLink" class="btn sm"><span class="icon">ðŸ”—</span> Copy Link</button>
          <button class="modal-close" id="modalClose" aria-label="Close">âœ•</button>
        </div>
      </div>
      <div id="modalBody"></div>
    </div>
  </div>

  <!-- Spinner + Toast -->
  <div class="spinner" id="spinner"><div class="ring"></div></div>
  <div class="toast" id="toast"></div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTRwAjNAQxiPP8uR15t_vx03JkjgEBjgUwp2bpx8rsHx-JJxVDBZyf5ap77rAKrYHfgkVMwLJVm6pGn/pub?output=csv";
  const FORM_URL = "FORM_URL_HERE"; // replace with your Google Form link

  // Elements
  const els = {
    tableBody: q('#issuesTable tbody'),
    rowCount: q('#rowCount'),
    moduleFilter: q('#moduleFilter'),
    priorityFilter: q('#priorityFilter'),
    statusFilter: q('#statusFilter'),
    reset: q('#resetBtn'),
    refresh: q('#refreshNow'),
    kpis: q('#kpis'),
    modal: q('#issueModal'),
    modalBody: q('#modalBody'),
    modalTitle: q('#modalTitle'),
    copyId: q('#copyId'),
    copyLink: q('#copyLink'),
    closeModal: q('#modalClose'),
    drawerBtn: q('#drawerBtn'),
    sidebar: q('#sidebar'),
    spinner: q('#spinner'),
    toast: q('#toast'),
    search: q('#searchInput'),
    themeSelect: q('#themeSelect'),
    firstPage: q('#firstPage'),
    prevPage: q('#prevPage'),
    nextPage: q('#nextPage'),
    lastPage: q('#lastPage'),
    pageInfo: q('#pageInfo'),
    pageSize: q('#pageSize'),
    newTicket: q('#newTicketBtn'),
    exportBtn: q('#exportBtn')
  };

  // State
  let rows = [], filtered = [], charts = {};
  let sortKey = null, sortAsc = true;
  let currentPage = 1, rowsPerPage = +els.pageSize.value;
  let selectedIssue = null;

  // Utils
  function q(s, r = document) { return r.querySelector(s); }
  function qAll(sel){ return Array.from(document.querySelectorAll(sel)); }
  const debounce = (fn, ms=250) => { let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; };
  const showSpinner = (v=true)=> els.spinner.style.display = v ? 'flex' : 'none';
  const showToast = (msg, ms=3500) => { els.toast.textContent = msg; els.toast.style.display = 'block'; setTimeout(()=>els.toast.style.display='none', ms); };

  function normalizeRow(raw){
    const lower={}; for(const k in raw){ if(!k) continue; lower[k.toLowerCase().replace(/\s+/g,' ').trim()]=String(raw[k]??'').trim(); }
    const pick=(...keys)=>{ for(const key of keys){ if(lower[key]) return lower[key]; } return ''; };
    return {
      id: pick('ticket id','id'),
      module: (pick('impacted module','module','issue location')||'Unspecified'),
      title: pick('title'),
      desc: pick('description'),
      file: pick('file upload','link','url'),
      priority: pick('priority'),
      status: pick('status')||'Not Started Yet',
      type: pick('category','type'),
      date: pick('timestamp','date','created at'),
      log: pick('log','logs','comment','notes')
    };
  }
  function parseCsv(t){ return Papa.parse(t,{header:true,skipEmptyLines:true}).data.map(normalizeRow).filter(r=>r.id||r.title||r.module); }
  function pill(text,cls){ return `<span class="pill ${cls}">${text||'-'}</span>`; }
  const statusBadge = s => pill(s,`status-${(s||'').replace(/\s/g,'\\ ')}`);  
  const priorityBadge = p => pill(p,`priority-${p||''}`);

  // Export CSV
  function exportCsv() {
    if (!filtered.length) {
      showToast('No data to export');
      return;
    }
    const fields = ["id","module","title","priority","status","date","desc","log","file"];
    const data = filtered.map(r => {
      return fields.reduce((obj, f) => {
        obj[f] = r[f] || "";
        return obj;
      }, {});
    });
    const csv = Papa.unparse(data, { columns: fields });
    const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url; a.download = "issues_export.csv";
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }

  // Theme
  const applyTheme = (mode) => {
    if(mode==='system'){ localStorage.setItem('theme','system'); document.documentElement.removeAttribute('data-theme'); return; }
    document.documentElement.setAttribute('data-theme',mode);
    localStorage.setItem('theme', mode);
  };
  const initTheme = () => {
    const saved = localStorage.getItem('theme') || 'system';
    els.themeSelect.value = saved;
    if(saved==='system'){ document.documentElement.removeAttribute('data-theme'); }
    else { document.documentElement.setAttribute('data-theme', saved); }
  };

  // Rest of your existing filters, renderers, charts, modal, pagination code (unchanged)...

  // Events
  els.exportBtn.addEventListener('click', exportCsv);
  els.newTicket.addEventListener('click', ()=> window.open(FORM_URL, "_blank"));

  initTheme();
  loadSheet();
});
</script>
</body>
</html>
