<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>InCheck Issues Dashboard</title>

  <!-- Libs -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    :root {
      /* Status colors */
      --status-resolved:#10b981;
      --status-underdev:#3b82f6;
      --status-rejected:#ef4444;
      --status-onhold:#f59e0b;
      --status-notstarted:#6b7280;
      --status-sent:#8b5cf6;
      --status-onstage:#0ea5e9;

      /* Priority colors */
      --priority-high:#ef4444;
      --priority-medium:#f59e0b;
      --priority-low:#10b981;

      /* Theme colors */
      --bg:#0b1020; --card:#0f1630; --muted:#9aa6d1; --text:#e8edff;
      --accent:#4f8cff; --danger:#ef4444; --ok:#10b981; --warn:#f59e0b;
      --info:#3b82f6; --purple:#8b5cf6; --neutral:#6b7280; --border:#1e2643;
      --shadow:0 8px 24px rgba(0,0,0,.35);
      --focus: 0 0 0 3px rgba(79,140,255,.35);
    }
    :root[data-theme="light"] {
      --bg:#f4f6ff; --card:#ffffff; --muted:#5a678c; --text:#0d1326;
      --accent:#2563eb; --danger:#dc2626; --ok:#059669; --warn:#d97706;
      --info:#1d4ed8; --purple:#7c3aed; --neutral:#374151; --border:#e7eaf6;
      --shadow:0 10px 24px rgba(16,24,40,.08);
      --focus: 0 0 0 3px rgba(37,99,235,.25);
    }

    * { box-sizing:border-box }
    html,body { height:100% }
    body {
      margin:0; font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;
      background:var(--bg); color:var(--text); transition:background .3s,color .3s;
    }
    :focus-visible { outline: none; box-shadow: var(--focus); border-radius: 8px; }

    /* Topbar */
    header {
      position:sticky; top:0; z-index:20; background:var(--card);
      border-bottom:1px solid var(--border);
      display:flex; align-items:center; gap:12px; padding:10px 16px;
      box-shadow:var(--shadow);
    }
    .brand { display:flex; align-items:center; gap:10px; font-weight:700; }
    .brand .logo {
      width:28px; height:28px; border-radius:8px; display:grid; place-items:center;
      background:linear-gradient(135deg,var(--accent),#9b8cff);
      color:#fff; font-weight:800; box-shadow:0 6px 18px rgba(79,140,255,.35);
    }
    .toolbar { margin-left:auto; display:flex; gap:10px; align-items:center; flex-wrap:wrap }
    .btn, .select, .input {
      padding:8px 12px; border-radius:10px; border:1px solid var(--border);
      background:transparent; color:inherit; font:inherit;
    }
    .btn { cursor:pointer; font-weight:600; background:var(--card) }
    .btn.primary { background:var(--accent); border-color:transparent; color:#fff }
    .btn.ghost { border-color:transparent; background:transparent }
    .btn:hover { opacity:.92; transform:translateY(-1px) }
    .btn.sm { padding:6px 8px; font-size:12px; border-radius:8px; }
    .icon { font-size:18px; line-height:1 }

    /* Layout */
    .wrap { display:grid; grid-template-columns:280px 1fr; gap:18px; padding:18px; max-width:1400px; margin:0 auto }
    @media(max-width:980px){ .wrap { grid-template-columns:1fr } }

    /* Sidebar */
    .sidebar {
      background:var(--card); border:1px solid var(--border); border-radius:14px; padding:16px;
      position:sticky; top:76px; height:fit-content; max-height:calc(100vh - 96px); overflow:auto;
    }
    .sidebar h3 { margin:0 0 10px 0; font-size:14px; color:var(--muted); text-transform:uppercase; letter-spacing:.06em }
    .filter-group { display:grid; gap:10px; margin-bottom:16px }
    .filter-row { display:grid; gap:8px }
    .muted { color:var(--muted); font-size:12px }
    .divider { height:1px; background:var(--border); margin:8px 0 14px }

    /* Content */
    .content { display:grid; gap:18px }
    .grid { display:grid; gap:16px }
    .grid.cols-4 { grid-template-columns:repeat(4,1fr) }
    @media(max-width:980px){ .grid.cols-4{ grid-template-columns:repeat(2,1fr) } }
    @media(max-width:600px){ .grid.cols-4{ grid-template-columns:1fr } }

    /* Cards */
    .card {
      background:var(--card); border:1px solid var(--border); border-radius:14px; padding:16px;
      box-shadow:var(--shadow); transition:transform .2s, box-shadow .2s;
    }
    .card:hover { transform:translateY(-2px) }

    /* KPIs */
    .kpi { cursor:pointer; text-align:center; }
    .kpi .label { font-size:12px; color:var(--muted); text-transform:uppercase }
    .kpi .value { font-size:26px; font-weight:800; margin-top:6px }
    .kpi .sub { font-size:12px; color:var(--muted); margin-top:4px }
    .kpi:hover { box-shadow:0 8px 26px rgba(79,140,255,.15) }

    /* Charts */
    .charts { display:grid; grid-template-columns:repeat(2,1fr); gap:16px }
    @media(max-width:980px){ .charts{ grid-template-columns:1fr } }

    /* Table */
    table { width:100%; border-collapse:separate; border-spacing:0; font-size:14px }
    thead th {
      position:sticky; top:0; background:var(--card); text-align:left; padding:12px 10px;
      border-bottom:1px solid var(--border); user-select:none; cursor:pointer;
    }
    tbody td { padding:11px 10px; border-bottom:1px solid var(--border) }
    tr:hover { background:rgba(255,255,255,.03) }
    .table-wrap { max-height:460px; overflow:auto; border-radius:10px; border:1px solid var(--border) }
    th.sortable::after { content:" ⇅"; color:var(--muted); font-size:12px }
    th.sorted-asc::after { content:" ↑" }
    th.sorted-desc::after { content:" ↓" }

    .pill { padding:2px 8px; border-radius:12px; font-size:12px; font-weight:700; display:inline-block }
    .status-Resolved { background: var(--status-resolved); color:#fff }
    .status-Under\ Development { background: var(--status-underdev); color:#fff }
    .status-Rejected { background: var(--status-rejected); color:#fff }
    .status-On\ Hold { background: var(--status-onhold); color:#fff }
    .status-Not\ Started\ Yet { background: var(--status-notstarted); color:#fff }
    .status-Sent { background: var(--status-sent); color:#fff }
    .status-On\ Stage { background: var(--status-onstage); color:#fff }

    .priority-High { background: var(--priority-high); color:#fff }
    .priority-Medium { background: var(--priority-medium); color:#fff }
    .priority-Low { background: var(--priority-low); color:#fff }

    /* Modal */
    .modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,.55); align-items:center; justify-content:center; z-index:100 }
    .modal-content { background:var(--card); color:var(--text); border:1px solid var(--border);
      padding:18px; border-radius:14px; max-width:760px; width:92%; max-height:90%; overflow:auto; box-shadow:var(--shadow) }
    .modal .header { display:flex; align-items:center; gap:10px; justify-content:space-between; margin-bottom:8px }
    .modal .actions { display:flex; gap:8px; flex-wrap: wrap; }
    .modal-close { cursor:pointer; border:none; background:transparent; color:var(--muted); font-size:20px }

    /* Pagination */
    .table-actions { display:flex; gap:10px; align-items:center; justify-content:space-between; margin-top:10px; flex-wrap:wrap }
    .pagination { display:flex; gap:6px; align-items:center }
    .chip { padding:6px 10px; border-radius:8px; background:var(--card); border:1px solid var(--border); cursor:pointer }
    .chip[disabled] { opacity:.5; cursor:not-allowed }
    .chip.active { background:var(--accent); color:#fff; border-color:transparent }
    .select.sm, .input.sm { padding:6px 8px; border-radius:8px; font-size:13px }

    /* Drawer */
    .drawer-toggle { display:none }
    @media(max-width:980px){
      .drawer-toggle { display:inline-flex }
      .sidebar { position:fixed; inset:76px 0 0 auto; width:88%; max-width:360px; transform:translateX(110%); transition:transform .25s }
      .sidebar.open { transform:translateX(0) }
    }

    /* Spinner & Toast */
    .spinner { display:none; position:fixed; inset:0; background:rgba(0,0,0,.35); z-index:120; align-items:center; justify-content:center }
    .spinner .ring { width:54px; height:54px; border:5px solid var(--border); border-top-color:var(--accent); border-radius:50%; animation:spin 1s linear infinite; background:transparent }
    @keyframes spin { to { transform:rotate(360deg) } }

    .toast {
      position:fixed; right:16px; bottom:16px; background:var(--card); border:1px solid var(--danger);
      color:#fff; padding:10px 12px; border-radius:10px; z-index:130; box-shadow:var(--shadow); display:none
    }

    /* Utils */
    .hidden { display:none !important; }

    @media (prefers-reduced-motion: reduce){
      * { transition:none !important; animation:none !important }
    }
  </style>
</head>
<body>
  <header>
    <div class="brand" aria-label="InCheck brand">
      <div class="logo" aria-hidden="true">IC</div>
      <div>InCheck Issues</div>
    </div>

    <button id="drawerBtn" class="btn drawer-toggle" aria-expanded="false" aria-controls="sidebar">
      <span class="icon" aria-hidden="true">🧰</span> Filters
    </button>

    <div class="toolbar">
      <input id="searchInput" class="input" type="search" placeholder="Search ID, title, description, log…" aria-label="Search issues" />
      <select id="themeSelect" class="select" aria-label="Theme">
        <option value="system">System</option>
        <option value="dark">Dark</option>
        <option value="light">Light</option>
      </select>
      <button id="refreshNow" class="btn" aria-label="Refresh from source"><span class="icon" aria-hidden="true">🔄</span> Refresh</button>
      <button id="createTicketBtn" class="btn primary" aria-label="Create new ticket"><span class="icon" aria-hidden="true">➕</span> Create Ticket</button>
      <!-- 🔐 Admin toggle --><button id="adminBtn" class="btn"><span class="icon">🔑</span> Admin</button>
    </div>
  </header>

  <div class="wrap">
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar" aria-label="Filters">
      <h3>Filters</h3>
      <div class="filter-group" role="group" aria-label="Field filters">
        <div class="filter-row">
          <label class="muted" for="moduleFilter">Module</label>
          <select id="moduleFilter" class="select" aria-label="Filter by module"></select>
        </div>
        <div class="filter-row">
          <label class="muted" for="priorityFilter">Priority</label>
          <select id="priorityFilter" class="select" aria-label="Filter by priority"></select>
        </div>
        <div class="filter-row">
          <label class="muted" for="statusFilter">Status</label>
          <select id="statusFilter" class="select" aria-label="Filter by status"></select>
        </div>
      </div>

      <div class="divider" role="separator" aria-hidden="true"></div>

      <div class="filter-group" role="group" aria-label="Date range">
        <div class="filter-row">
          <label class="muted" for="startDateFilter">Start Date</label>
          <input type="date" id="startDateFilter" class="input" aria-label="Start date">
        </div>
        <div class="filter-row">
          <label class="muted" for="endDateFilter">End Date</label>
          <input type="date" id="endDateFilter" class="input" aria-label="End date">
        </div>
      </div>

      <div class="divider" role="separator" aria-hidden="true"></div>

      <div class="filter-group">
        <button id="resetBtn" class="btn ghost" aria-label="Reset all filters">Reset</button>
        <span class="muted">Tip: click any KPI to filter by that status.</span>
      </div>
    </aside>

    <!-- Main content -->
    <main class="content">
      <div class="grid cols-4" id="kpis" aria-live="polite"></div>

      <div class="charts" aria-label="Charts">
        <div class="card"><canvas id="byModule" height="140" aria-label="Issues by module" role="img"></canvas></div>
        <div class="card"><canvas id="byPriority" height="140" aria-label="Issues by priority" role="img"></canvas></div>
        <div class="card"><canvas id="byStatus" height="140" aria-label="Issues by status" role="img"></canvas></div>
        <div class="card"><canvas id="byType" height="140" aria-label="Issues by type" role="img"></canvas></div>
      </div>

      <div class="card" aria-label="Issues table">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
          <strong>Issues</strong>
          <span id="rowCount" class="muted" aria-live="polite"></span>
        </div>

        <div class="table-wrap" role="region" aria-label="Scrollable issues table">
          <table id="issuesTable">
            <thead><tr>
              <th data-key="id" class="sortable" scope="col" aria-sort="none" tabindex="0" role="button" aria-label="Sort by ID">ID</th>
              <th data-key="module" class="sortable" scope="col" aria-sort="none" tabindex="0" role="button" aria-label="Sort by Module">Module</th>
              <th data-key="title" class="sortable" scope="col" aria-sort="none" tabindex="0" role="button" aria-label="Sort by Title">Title</th>
              <th data-key="priority" class="sortable" scope="col" aria-sort="none" tabindex="0" role="button" aria-label="Sort by Priority">Priority</th>
              <th data-key="status" class="sortable" scope="col" aria-sort="none" tabindex="0" role="button" aria-label="Sort by Status">Status</th>
              <th data-key="date" class="sortable" scope="col" aria-sort="none" tabindex="0" role="button" aria-label="Sort by Date">Date</th>
              <th data-key="log" class="sortable" scope="col" aria-sort="none" tabindex="0" role="button" aria-label="Sort by Log">Log</th>
              <th scope="col">Link</th>
              <!-- Actions header injected dynamically when admin -->
            </tr></thead>
            <tbody>
              <tr><td colspan="8" style="text-align:center;color:var(--muted)">Loading…</td></tr>
            </tbody>
          </table>
        </div>

        <div class="table-actions">
          <div class="pagination" role="group" aria-label="Table pagination">
            <button id="firstPage" class="chip" aria-label="First page">« First</button>
            <button id="prevPage" class="chip" aria-label="Previous page">‹ Prev</button>
            <span id="pageInfo" class="muted" aria-live="polite"></span>
            <button id="nextPage" class="chip" aria-label="Next page">Next ›</button>
            <button id="lastPage" class="chip" aria-label="Last page">Last »</button>
          </div>
          <div style="display:flex;gap:8px;align-items:center">
            <label for="pageSize" class="muted">Rows per page</label>
            <select id="pageSize" class="select sm" aria-label="Rows per page">
              <option>10</option><option selected>20</option><option>41</option><option>50</option><option>100</option>
            </select>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- View Modal -->
  <div id="issueModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle" aria-describedby="modalBody">
    <div class="modal-content">
      <div class="header">
        <h2 id="modalTitle" style="margin:0;font-size:20px">Issue</h2>
        <div class="actions">
          <button id="copyId" class="btn sm" aria-label="Copy issue ID"><span class="icon" aria-hidden="true">🆔</span> Copy ID</button>
          <button id="copyLink" class="btn sm" aria-label="Copy issue link"><span class="icon" aria-hidden="true">🔗</span> Copy Link</button>
          <button class="modal-close" id="modalClose" aria-label="Close">✕</button>
        </div>
      </div>
      <div id="modalBody"></div>
    </div>
  </div>

  <!-- Edit Modal -->
  <div id="editModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="editTitleLbl">
    <div class="modal-content">
      <div class="header">
        <h2 id="editTitleLbl" style="margin:0;font-size:20px">Edit Issue</h2>
        <div class="actions">
          <button class="modal-close" id="editClose" aria-label="Close edit modal">✕</button>
        </div>
      </div>

      <form id="editForm">
        <div style="display:grid;gap:10px;grid-template-columns:repeat(2,1fr)">
          <label>Title <input id="e_title" class="input" required></label>
          <label>Module <input id="e_module" class="input"></label>
          <label>Priority
            <select id="e_priority" class="select">
              <option>High</option><option>Medium</option><option>Low</option>
            </select>
          </label>
          <label>Status
            <select id="e_status" class="select">
              <option>Not Started Yet</option>
              <option>Under Development</option>
              <option>On Hold</option>
              <option>On Stage</option>
              <option>Sent</option>
              <option>Resolved</option>
              <option>Rejected</option>
            </select>
          </label>
          <label>Date <input id="e_date" class="input" type="date"></label>
          <label>Link <input id="e_file" class="input" type="url" placeholder="https://..."></label>
        </div>
        <label style="display:block;margin-top:10px">Description
          <textarea id="e_desc" class="input" style="width:100%;min-height:100px"></textarea>
        </label>
        <label style="display:block;margin-top:10px">Log
          <textarea id="e_log" class="input" style="width:100%;min-height:80px"></textarea>
        </label>

        <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
          <button type="button" id="editCancel" class="btn">Cancel</button>
          <button type="submit" id="editSave" class="btn primary">Save</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Spinner + Toast -->
  <div class="spinner" id="spinner" aria-hidden="true"><div class="ring"></div></div>
  <div class="toast" id="toast" role="status" aria-live="polite"></div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTRwAjNAQxiPP8uR15t_vx03JkjgEBjgUwp2bpx8rsHx-JJxVDBZyf5ap77rAKrYHfgkVMwLJVm6pGn/pub?output=csv";

  // OPTIONAL: if you set up Google Apps Script to persist edits, put its URL here:
  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxFp7K40NnxHyaVxPTJZMUejpP5wI1hz_8a09RemxU1mwCYU55_kPlwKjisQ3oWE9OJGg/exec"; // e.g., "https://script.google.com/macros/s/XXXX/exec" or leave empty to disable

  // 🔐 ADMIN: replace this with your own SHA-256 hex of a strong passphrase.
  // How to generate in browser console:
  // (async()=>{ const s="your-passphrase"; const e=new TextEncoder().encode(s);
  //  const h=await crypto.subtle.digest("SHA-256",e);
  //  console.log(Array.from(new Uint8Array(h)).map(b=>b.toString(16).padStart(2,"0")).join("")); })();
 // Just store the passphrase directly
const ADMIN_PASS = "ilovemywork";

function askForAdmin() {
  const pass = prompt("Enter admin passphrase:");
  if (pass === ADMIN_PASS) {
    alert("✅ Admin mode enabled");
    document.body.classList.add("admin"); // show edit buttons etc.
  } else {
    alert("❌ Incorrect passphrase");
  }
}

  // Elements
  const els = {
    table: q('#issuesTable'),
    tableBody: q('#issuesTable tbody'),
    rowCount: q('#rowCount'),
    moduleFilter: q('#moduleFilter'),
    priorityFilter: q('#priorityFilter'),
    statusFilter: q('#statusFilter'),
    reset: q('#resetBtn'),
    refresh: q('#refreshNow'),
    kpis: q('#kpis'),
    modal: q('#issueModal'),
    modalBody: q('#modalBody'),
    modalTitle: q('#modalTitle'),
    copyId: q('#copyId'),
    copyLink: q('#copyLink'),
    closeModal: q('#modalClose'),
    drawerBtn: q('#drawerBtn'),
    sidebar: q('#sidebar'),
    spinner: q('#spinner'),
    toast: q('#toast'),
    search: q('#searchInput'),
    themeSelect: q('#themeSelect'),
    firstPage: q('#firstPage'),
    prevPage: q('#prevPage'),
    nextPage: q('#nextPage'),
    lastPage: q('#lastPage'),
    pageInfo: q('#pageInfo'),
    pageSize: q('#pageSize'),
    createTicket: q('#createTicketBtn'),
    adminBtn: q('#adminBtn')
  };

  // Edit modal elements
  const editEls = {
    modal: q('#editModal'),
    close: q('#editClose'),
    cancel: q('#editCancel'),
    form: q('#editForm'),
    fields: {
      title: q('#e_title'),
      module: q('#e_module'),
      priority: q('#e_priority'),
      status: q('#e_status'),
      date: q('#e_date'),
      file: q('#e_file'),
      desc: q('#e_desc'),
      log: q('#e_log'),
    }
  };

  // State
  let rows = [], filtered = [], charts = {};
  let sortKey = null, sortAsc = true;
  let currentPage = 1, rowsPerPage = +els.pageSize.value;
  let selectedIssue = null;
  let lastFocusedBeforeModal = null;
  let editingId = null;
  let isAdmin = localStorage.getItem('incheck_isAdmin') === '1';

  // Local edit patches
  const LS_KEY = 'incheck_local_edits';

  // Utils
  function q(s, r = document) { return r.querySelector(s); }
  function qAll(sel){ return Array.from(document.querySelectorAll(sel)); }
  const debounce = (fn, ms=250) => { let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; };
  const showSpinner = (v=true)=> els.spinner.style.display = v ? 'flex' : 'none';
  const showToast = (msg, ms=3500) => { els.toast.textContent = msg; els.toast.style.display = 'block'; setTimeout(()=>els.toast.style.display='none', ms); };

  // Security helpers
  async function sha256Hex(s){
    const enc = new TextEncoder().encode(s);
    const h = await crypto.subtle.digest('SHA-256', enc);
    return Array.from(new Uint8Array(h)).map(b=>b.toString(16).padStart(2,'0')).join('');
  }
  async function adminLoginFlow(){
    const pass = prompt('Enter admin passphrase:');
    if(!pass) return;
    const hex = await sha256Hex(pass);
    if(hex === ADMIN_HASH){
      isAdmin = true;
      localStorage.setItem('incheck_isAdmin','1');
      showToast('Admin mode enabled');
      renderTable(); // show Edit column
    }else{
      showToast('Incorrect passphrase');
    }
  }
  function adminLogout(){
    isAdmin = false;
    localStorage.removeItem('incheck_isAdmin');
    showToast('Admin mode disabled');
    renderTable(); // hide Edit column
  }

  // Local edits store
  function loadLocalEdits(){
    try{ return JSON.parse(localStorage.getItem(LS_KEY)||'{}'); } catch{ return {}; }
  }
  function saveLocalEdits(obj){
    localStorage.setItem(LS_KEY, JSON.stringify(obj));
  }
  function applyLocalEditsToRows(){
    const patches = loadLocalEdits();
    rows = rows.map(r => patches[r.id] ? { ...r, ...patches[r.id] } : r);
  }

  // Theme
  const applyTheme = (mode) => {
    if(mode==='system'){ localStorage.setItem('theme','system'); document.documentElement.removeAttribute('data-theme'); return; }
    document.documentElement.setAttribute('data-theme',mode);
    localStorage.setItem('theme', mode);
  };
  const initTheme = () => {
    const saved = localStorage.getItem('theme') || 'system';
    els.themeSelect.value = saved;
    if(saved==='system'){ document.documentElement.removeAttribute('data-theme'); }
    else { document.documentElement.setAttribute('data-theme', saved); }
  };

  // CSV normalization
  function normalizeRow(raw){
    const lower={}; for(const k in raw){ if(!k) continue; lower[k.toLowerCase().replace(/\s+/g,' ').trim()]=String(raw[k]??'').trim(); }
    const pick=(...keys)=>{ for(const key of keys){ if(lower[key]) return lower[key]; } return ''; };
    return {
      id: pick('ticket id','id'),
      module: (pick('impacted module','module','issue location')||'Unspecified'),
      title: pick('title'),
      desc: pick('description'),
      file: pick('file upload','link','url'),
      priority: pick('priority'),
      status: pick('status')||'Not Started Yet',
      type: pick('category','type'),
      date: pick('timestamp','date','created at'),
      log: pick('log','logs','comment','notes')
    };
  }
  function parseCsv(t){ return Papa.parse(t,{header:true,skipEmptyLines:true}).data.map(normalizeRow); }
  function pill(text,cls){ return `<span class="pill ${cls}">${text||'-'}</span>`; }
  const statusBadge = s => pill(s,`status-${(s||'').replace(/\s/g,'\\ ')}`);
  const priorityBadge = p => pill(p,`priority-${p||''}`);

  // KPI rendering with percentage
  function renderKpis(){
    const total=filtered.length; const counts={};
    filtered.forEach(r=>{ counts[r.status]=(counts[r.status]||0)+1; });
    els.kpis.innerHTML='';
    const add=(label,val)=>{
      const pct = total ? Math.round((val*100)/total) : 0;
      const d=document.createElement('div');
      d.className='card kpi';
      d.setAttribute('role','button');
      d.setAttribute('tabindex','0');
      d.setAttribute('aria-label',`${label}: ${val} (${pct} percent)`);
      d.innerHTML=`<div class="label">${label}</div><div class="value">${val}</div><div class="sub">${pct}%</div>`;
      d.onclick=()=>{ if(label!=='Total Issues'){ els.statusFilter.value=label; applyFilters(); } };
      d.addEventListener('keydown', e=>{ if(e.key==='Enter' || e.key===' '){ e.preventDefault(); d.click(); }});
      els.kpis.appendChild(d);
    };
    add('Total Issues', total);
    Object.entries(counts).forEach(([s,v])=> add(s, v));
  }

  function uniqueSorted(arr){ return [...new Set(arr.filter(Boolean).map(v=>v.trim()))].sort((a,b)=>a.localeCompare(b)); }
  function renderFilters(){
    els.moduleFilter.innerHTML = ['All',...uniqueSorted(rows.map(r=>r.module))].map(v=>`<option>${v}</option>`).join('');
    els.priorityFilter.innerHTML = ['All',...uniqueSorted(rows.map(r=>r.priority))].map(v=>`<option>${v}</option>`).join('');
    els.statusFilter.innerHTML = ['All',...uniqueSorted(rows.map(r=>r.status))].map(v=>`<option>${v}</option>`).join('');
  }

  // Sorting
  function sortData(list){
    if(!sortKey) return list;
    const sorted=[...list].sort((a,b)=>{
      const va=a[sortKey]||"", vb=b[sortKey]||"";
      if(sortKey==='date'){
        const da=new Date(va), db=new Date(vb);
        if(isNaN(da)&&isNaN(db)) return 0;
        if(isNaN(da)) return 1;
        if(isNaN(db)) return -1;
        return da - db;
      }
      return String(va).localeCompare(String(vb), undefined, {numeric:true, sensitivity:'base'});
    });
    return sortAsc ? sorted : sorted.reverse();
  }

  // Pagination helpers
  function paginate(list){
    const start=(currentPage-1)*rowsPerPage;
    return list.slice(start, start+rowsPerPage);
  }
  function updatePaginationControls(total){
    const totalPages = Math.max(1, Math.ceil(total/rowsPerPage));
    currentPage = Math.min(currentPage, totalPages);
    els.pageInfo.textContent = `Page ${Math.min(currentPage,totalPages)} / ${totalPages}`;
    const atFirst = currentPage<=1;
    const atLast = currentPage>=totalPages;
    els.firstPage.disabled = atFirst;
    els.prevPage.disabled = atFirst;
    els.nextPage.disabled = atLast;
    els.lastPage.disabled = atLast;
    [els.firstPage, els.prevPage, els.nextPage, els.lastPage].forEach(btn=>{
      if(btn.disabled) btn.setAttribute('disabled','true'); else btn.removeAttribute('disabled');
    });
  }

  function ensureActionsHeader(){
    const theadRow = q('#issuesTable thead tr');
    const hasActions = !!theadRow.querySelector('th[data-actions]');
    if(isAdmin && !hasActions){
      const th = document.createElement('th');
      th.textContent = 'Actions';
      th.setAttribute('data-actions','true');
      theadRow.appendChild(th);
    } else if(!isAdmin && hasActions){
      theadRow.querySelector('th[data-actions]').remove();
    }
  }

  // Table render
  function renderTable(){
    ensureActionsHeader();

    const list = sortData(filtered);
    const total = list.length;
    updatePaginationControls(total);
    els.rowCount.textContent = `${total} row${total===1?'':'s'}`;

    if (!total){
      els.tableBody.innerHTML = `<tr><td colspan="${isAdmin?9:8}" style="text-align:center;color:var(--muted)">No issues found. Adjust filters or search.</td></tr>`;
      updateSortedHeaders();
      return;
    }

    const pageData = paginate(list);
    if (!pageData.length){
      els.tableBody.innerHTML = `<tr><td colspan="${isAdmin?9:8}" style="text-align:center;color:var(--muted)">No issues on this page.</td></tr>`;
      updateSortedHeaders();
      return;
    }

    els.tableBody.innerHTML = pageData.map(r=>`
      <tr role="button" tabindex="0" aria-label="Open issue ${r.id||'without ID'}" data-id="${r.id}">
        <td>${r.id||'-'}</td>
        <td>${r.module||'-'}</td>
        <td>${r.title||'-'}</td>
        <td>${priorityBadge(r.priority||'-')}</td>
        <td>${statusBadge(r.status||'-')}</td>
        <td>${r.date||'-'}</td>
        <td>${r.log||'-'}</td>
        <td>${r.file?`<a href="${escapeAttr(r.file)}" target="_blank" rel="noopener" aria-label="Open attachment link">🔗</a>`:'-'}</td>
        ${isAdmin ? `<td><button class="btn sm edit-btn" data-id="${escapeAttr(r.id||'')}" aria-label="Edit ${escapeAttr(r.id||'')}">✏️ Edit</button></td>`:''}
      </tr>
    `).join('');

    // Row keyboard opening
    els.tableBody.querySelectorAll('tr[data-id]').forEach(tr=>{
      tr.addEventListener('keydown', e=>{ if(e.key==='Enter' || e.key===' '){ e.preventDefault(); openModal(tr.getAttribute('data-id')); }});
    });

    bindEditButtons();
    updateSortedHeaders();
  }

  function bindEditButtons(){
    if(!isAdmin) return;
    qAll('.edit-btn').forEach(btn=>{
      btn.addEventListener('click', (e)=>{
        e.stopPropagation();
        const id = btn.getAttribute('data-id');
        openEditModal(id);
      });
    });
  }

  function updateSortedHeaders(){
    qAll('#issuesTable thead th').forEach(th => {
      th.classList.remove('sorted-asc','sorted-desc');
      th.setAttribute('aria-sort','none');
    });
    if(sortKey){
      const th = q(`#issuesTable thead th[data-key="${sortKey}"]`);
      if(th){
        th.classList.add(sortAsc?'sorted-asc':'sorted-desc');
        th.setAttribute('aria-sort', sortAsc ? 'ascending' : 'descending');
      }
    }
  }

  // Charts
  function groupCount(list,key){
    return list.reduce((acc, r) => {
      const k=r[key]||'Unspecified';
      acc[k]=(acc[k]||0)+1;
      return acc;
    },{});
  }
  function cssVar(name) { return getComputedStyle(document.documentElement).getPropertyValue(name).trim(); }

  function drawCharts(){
    const priorityColors = {
      High: cssVar('--priority-high'),
      Medium: cssVar('--priority-medium'),
      Low: cssVar('--priority-low')
    };

    const statusColors = {
      "Resolved": cssVar('--status-resolved'),
      "Under Development": cssVar('--status-underdev'),
      "Rejected": cssVar('--status-rejected'),
      "On Hold": cssVar('--status-onhold'),
      "Not Started Yet": cssVar('--status-notstarted'),
      "Sent": cssVar('--status-sent'),
      "On Stage": cssVar('--status-onstage')
    };

    const make = (id, type, data, colorMap={}) => {
      if(charts[id]) charts[id].destroy();
      const labels = Object.keys(data);
      const values = Object.values(data);
      charts[id] = new Chart(q('#'+id), {
        type,
        data: {
          labels,
          datasets: [{
            data: values,
            backgroundColor: labels.map(k => colorMap[k] || cssVar('--accent'))
          }]
        },
        options: {
          responsive: true, maintainAspectRatio: false,
          plugins: {
            legend: { display: type !== 'bar' },
            tooltip: {
              callbacks: {
                label: ctx => {
                  const total = values.reduce((a,b)=>a+b,0) || 1;
                  const pct = Math.round((ctx.raw*100)/total);
                  return `${ctx.raw} (${pct}%)`;
                }
              }
            }
          },
          scales: type === 'bar' ? {
            x: { grid: { color: 'rgba(128,128,128,.1)' } },
            y: { beginAtZero: true, grid: { color: 'rgba(128,128,128,.12)' } }
          } : {}
        }
      });
    };

    make('byModule', 'bar', groupCount(filtered,'module'));
    make('byPriority', 'doughnut', groupCount(filtered,'priority'), priorityColors);
    make('byStatus', 'bar', groupCount(filtered,'status'), statusColors);
    make('byType', 'bar', groupCount(filtered,'type'));
  }

  // Filters
  function applyFilters(){
    const qstr = (els.search.value||'').toLowerCase().trim();
    const m = els.moduleFilter.value, p = els.priorityFilter.value, s = els.statusFilter.value;
    const start = q('#startDateFilter').value, end = q('#endDateFilter').value;
    const startDate = start ? new Date(start) : null;
    const endDate = end ? (()=>{ const d=new Date(end); d.setDate(d.getDate()+1); return d; })() : null;

    filtered = rows.filter(r=>{
      const hay = [r.id,r.module,r.title,r.desc,r.log].filter(Boolean).join(' ').toLowerCase();
      let keepDate = true;
      if(r.date){
        const d = new Date(r.date);
        if(!isNaN(d)){
          if(startDate && d < startDate) keepDate = false;
          if(endDate && d >= endDate) keepDate = false;
        }
      } else if(startDate || endDate){ keepDate = false; }
      return (!qstr || hay.includes(qstr))
        && (!m || m==='All' || r.module===m)
        && (!p || p==='All' || r.priority===p)
        && (!s || s==='All' || r.status===s)
        && keepDate;
    });

    currentPage = 1;
    renderKpis();
    renderTable();
    drawCharts();
  }

  // Data
  async function loadSheet(){
    try {
      showSpinner(true);
      const res = await fetch(SHEET_URL, { cache:'no-store' });
      if(!res.ok) throw new Error(`Failed to fetch (${res.status})`);
      const text = await res.text();

      rows = parseCsv(text)

        // STRICT: remove phantom/blank rows (fixes "41 not 46")
        .filter(r => r.id && r.id.trim() !== '');

      applyLocalEditsToRows();   // merge your local patches
      filtered = [...rows];
      renderFilters();
      applyFilters();
    } catch(e) {
      showToast('Error loading data: '+e.message);
      els.tableBody.innerHTML = `<tr><td colspan="8" style="color:#ffb4b4;text-align:center">Error loading data.</td></tr>`;
    } finally {
      showSpinner(false);
    }
  }

  // View Modal
  function openModal(id){
    const r = rows.find(x=>x.id===id);
    if(!r) return;
    selectedIssue = r;
    lastFocusedBeforeModal = document.activeElement;

    els.modalTitle.textContent = r.title || r.id || 'Issue';
    els.modalBody.innerHTML = `
      <p><b>ID:</b> ${escapeHtml(r.id || '-')}</p>
      <p><b>Module:</b> ${escapeHtml(r.module || '-')}</p>
      <p><b>Priority:</b> ${escapeHtml(r.priority || '-')}</p>
      <p><b>Status:</b> ${escapeHtml(r.status || '-')}</p>
      <p><b>Date:</b> ${escapeHtml(r.date || '-')}</p>
      <p><b>Description:</b><br>${escapeHtml(r.desc || '-')}</p>
      <p><b>Log:</b><br>${escapeHtml(r.log || '-')}</p>
      ${r.file ? `<p><b>Attachment:</b> <a href="${escapeAttr(r.file)}" target="_blank" rel="noopener">Open link</a></p>` : ''}
    `;
    els.modal.style.display='flex';
    els.copyId.focus();
  }
  function closeModal(){
    els.modal.style.display='none';
    selectedIssue=null;
    if(lastFocusedBeforeModal && typeof lastFocusedBeforeModal.focus==='function'){ lastFocusedBeforeModal.focus(); }
  }

  // Edit Modal
  function openEditModal(id){
    const r = rows.find(x=>x.id===id);
    if(!r) return showToast('Issue not found');

    editingId = id;
    editEls.fields.title.value   = r.title || '';
    editEls.fields.module.value  = r.module || '';
    editEls.fields.priority.value= r.priority || 'Medium';
    editEls.fields.status.value  = r.status || 'Not Started Yet';
    const d = r.date ? new Date(r.date) : null;
    editEls.fields.date.value    = (d && !isNaN(d)) ? new Date(d.getTime()-d.getTimezoneOffset()*60000).toISOString().slice(0,10) : '';
    editEls.fields.file.value    = r.file || '';
    editEls.fields.desc.value    = r.desc || '';
    editEls.fields.log.value     = r.log || '';

    editEls.modal.style.display='flex';
    editEls.fields.title.focus();
  }
  function closeEditModal(){ editEls.modal.style.display='none'; editingId=null; }

  // Events: view modal
  q('#issuesTable').addEventListener('click', (ev)=>{
    const tr = ev.target.closest('tr[data-id]');
    if(tr){ openModal(tr.getAttribute('data-id')); }
  });
  els.closeModal.addEventListener('click', closeModal);
  els.modal.addEventListener('click', (e)=>{ if(e.target===els.modal) closeModal(); });
  document.addEventListener('keydown', (e)=>{ if(e.key==='Escape' && els.modal.style.display==='flex') closeModal(); });

  els.copyId.addEventListener('click', async ()=>{
    if(!selectedIssue) return;
    try{
      await navigator.clipboard.writeText(selectedIssue.id || '');
      showToast('Issue ID copied');
    }catch{ showToast('Unable to copy (clipboard blocked)'); }
  });
  els.copyLink.addEventListener('click', async ()=>{
    if(!selectedIssue) return;
    const link = selectedIssue.file || '';
    if(!link){ showToast('No link on this issue'); return; }
    try{
      await navigator.clipboard.writeText(link);
      showToast('Link copied');
    }catch{ showToast('Unable to copy (clipboard blocked)'); }
  });

  // Events: edit modal
  editEls.close.addEventListener('click', closeEditModal);
  editEls.cancel.addEventListener('click', closeEditModal);
  editEls.modal.addEventListener('click', (e)=>{ if(e.target===editEls.modal) closeEditModal(); });
  document.addEventListener('keydown', (e)=>{ if(e.key==='Escape' && editEls.modal.style.display==='flex') closeEditModal(); });

  editEls.form.addEventListener('submit', async (e)=>{
    e.preventDefault();
    if(!editingId) return;

    const patch = {
      title:   editEls.fields.title.value.trim(),
      module:  editEls.fields.module.value.trim(),
      priority:editEls.fields.priority.value,
      status:  editEls.fields.status.value,
      date:    editEls.fields.date.value, // yyyy-mm-dd
      file:    editEls.fields.file.value.trim(),
      desc:    editEls.fields.desc.value.trim(),
      log:     editEls.fields.log.value.trim()
    };

    // Update in-memory rows
    rows = rows.map(r => r.id===editingId ? { ...r, ...patch } : r);

    // Save to localStorage patches
    const patches = loadLocalEdits();
    patches[editingId] = { ...(patches[editingId]||{}), ...patch };
    saveLocalEdits(patches);

    // (Optional) Persist to server (Google Apps Script) if configured
    if(SCRIPT_URL){
      try{
        const res = await fetch(SCRIPT_URL, {
          method:'POST',
          headers:{ 'Content-Type':'application/json' },
          body: JSON.stringify({ id: editingId, ...patch })
        });
        const json = await res.json().catch(()=>({}));
        if(json && json.ok) showToast('Saved to Google Sheet');
        else showToast('Server save failed');
      }catch{ showToast('Network error saving to sheet'); }
    }

    closeEditModal();
    applyFilters(); // re-filter & redraw
    showToast('Saved (local)');
  });

  // Sorting
  qAll('#issuesTable thead th.sortable').forEach(th=>{
    th.addEventListener('click', ()=>{
      const key = th.getAttribute('data-key');
      if(sortKey===key){ sortAsc = !sortAsc; } else { sortKey=key; sortAsc=true; }
      renderTable();
    });
    th.addEventListener('keydown', e=>{
      if(e.key==='Enter' || e.key===' '){ e.preventDefault(); th.click(); }
    });
  });

  // Pagination
  const updateAndRender = ()=>{ renderTable(); };
  els.pageSize.addEventListener('change', ()=>{
    rowsPerPage = +els.pageSize.value;
    currentPage = 1;
    updateAndRender();
  });
  els.firstPage.addEventListener('click', ()=>{ currentPage=1; updateAndRender(); });
  els.prevPage.addEventListener('click', ()=>{ if(currentPage>1){ currentPage--; updateAndRender(); } });
  els.nextPage.addEventListener('click', ()=>{
    const totalPages = Math.max(1, Math.ceil(filtered.length/rowsPerPage));
    if(currentPage<totalPages){ currentPage++; updateAndRender(); }
  });
  els.lastPage.addEventListener('click', ()=>{
    currentPage = Math.max(1, Math.ceil(filtered.length/rowsPerPage));
    updateAndRender();
  });

  // Sidebar drawer
  els.drawerBtn.addEventListener('click', ()=>{
    const open = !els.sidebar.classList.contains('open');
    els.sidebar.classList.toggle('open');
    els.drawerBtn.setAttribute('aria-expanded', String(open));
  });

  // Filters & search
  const onFilterChange = ()=> applyFilters();
  [els.moduleFilter, els.priorityFilter, els.statusFilter].forEach(el=> el.addEventListener('change', onFilterChange));
  q('#startDateFilter').addEventListener('change', onFilterChange);
  q('#endDateFilter').addEventListener('change', onFilterChange);
  els.reset.addEventListener('click', ()=>{
    els.search.value=''; q('#startDateFilter').value=''; q('#endDateFilter').value='';
    renderFilters(); applyFilters();
  });
  els.refresh.addEventListener('click', loadSheet);
  els.search.addEventListener('input', debounce(applyFilters, 250));

  // Theme select
  els.themeSelect.addEventListener('change', ()=> applyTheme(els.themeSelect.value));
  initTheme();

  // Admin button
  els.adminBtn.addEventListener('click', async ()=>{
    if(!ADMIN_HASH || ADMIN_HASH.startsWith('REPLACE_')){
      alert('Please set ADMIN_HASH in the code first (SHA-256 hex of your passphrase).');
      return;
    }
    if(isAdmin) adminLogout(); else await adminLoginFlow();
  });

  // Initial load
  if(typeof Chart === 'undefined') { showToast('Chart.js failed to load'); }
  if(typeof Papa === 'undefined') { showToast('PapaParse failed to load'); }
  loadSheet();

  // Helpers
  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;', "'":'&#39;' }[m]));
  }
  function escapeAttr(s){
    return String(s).replace(/&/g,'&amp;').replace(/"/g,'&quot;');
  }
});
</script>
</body>
</html>
