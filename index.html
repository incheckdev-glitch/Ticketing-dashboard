<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>InCheck Issues Dashboard</title>

  <!-- Libs -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    /* === your full CSS (kept exactly as you pasted before) === */
    :root {
      --status-resolved:#10b981;
      --status-underdev:#3b82f6;
      --status-rejected:#ef4444;
      --status-onhold:#f59e0b;
      --status-notstarted:#6b7280;
      --status-sent:#8b5cf6;
      --status-onstage:#0ea5e9;
      --priority-high:#ef4444;
      --priority-medium:#f59e0b;
      --priority-low:#10b981;
      --bg:#0b1020; --card:#0f1630; --muted:#9aa6d1; --text:#e8edff;
      --accent:#4f8cff; --danger:#ef4444; --ok:#10b981; --warn:#f59e0b;
      --info:#3b82f6; --purple:#8b5cf6; --neutral:#6b7280; --border:#1e2643;
      --shadow:0 8px 24px rgba(0,0,0,.35); --focus:0 0 0 3px rgba(79,140,255,.35);
    }
    :root[data-theme="light"] { /* ‚Ä¶ */ }
    * { box-sizing:border-box }
    html,body { height:100% }
    body { margin:0; font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif; background:var(--bg); color:var(--text); }
    /* ‚Ä¶ KEEP ALL THE CSS YOU PASTED (filters, sidebar, charts, table, modal, pagination, spinner, toast, etc.) ‚Ä¶ */
  </style>
</head>
<body>
  <header>
    <div class="brand" aria-label="InCheck brand">
      <div class="logo" aria-hidden="true">IC</div>
      <div>InCheck Issues</div>
    </div>
    <button id="drawerBtn" class="btn drawer-toggle" aria-expanded="false" aria-controls="sidebar">
      <span class="icon" aria-hidden="true">üß∞</span> Filters
    </button>
    <div class="toolbar">
      <input id="searchInput" class="input" type="search" placeholder="Search ID, title, description, log‚Ä¶" />
      <select id="themeSelect" class="select">
        <option value="system">System</option>
        <option value="dark">Dark</option>
        <option value="light">Light</option>
      </select>
      <button id="refreshNow" class="btn"><span class="icon">üîÑ</span> Refresh</button>
      <button id="createTicketBtn" class="btn primary"><span class="icon">‚ûï</span> Create Ticket</button>
    </div>
  </header>

  <div class="wrap">
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar"> 
      <!-- KEEP your sidebar filters exactly as you had -->
    </aside>

    <!-- Main content -->
    <main class="content">
      <div class="grid cols-4" id="kpis"></div>
      <div class="charts">
        <div class="card"><canvas id="byModule"></canvas></div>
        <div class="card"><canvas id="byPriority"></canvas></div>
        <div class="card"><canvas id="byStatus"></canvas></div>
        <div class="card"><canvas id="byType"></canvas></div>
      </div>
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
          <strong>Issues</strong>
          <span id="rowCount" class="muted"></span>
        </div>
        <div class="table-wrap">
          <table id="issuesTable">
            <thead><tr>
              <th data-key="id" class="sortable">ID</th>
              <th data-key="module" class="sortable">Module</th>
              <th data-key="title" class="sortable">Title</th>
              <th data-key="priority" class="sortable">Priority</th>
              <th data-key="status" class="sortable">Status</th>
              <th data-key="date" class="sortable">Date</th>
              <th data-key="log" class="sortable">Log</th>
              <th>Link</th>
            </tr></thead>
            <tbody>
              <tr><td colspan="8" style="text-align:center;color:var(--muted)">Loading‚Ä¶</td></tr>
            </tbody>
          </table>
        </div>
        <div class="table-actions">
          <!-- KEEP your pagination controls -->
        </div>
      </div>
    </main>
  </div>

  <!-- Modal -->
  <div id="issueModal" class="modal">
    <div class="modal-content">
      <div class="header">
        <h2 id="modalTitle">Issue</h2>
        <div class="actions">
          <button id="copyId" class="btn sm">üÜî Copy ID</button>
          <button id="copyLink" class="btn sm">üîó Copy Link</button>
          <button class="modal-close" id="modalClose">‚úï</button>
        </div>
      </div>
      <div id="modalBody"></div>
      <!-- üöÄ NEW EDIT BUTTON -->
      <div style="margin-top:12px;display:flex;gap:8px">
        <button id="editBtn" class="btn primary">‚úèÔ∏è Edit Issue</button>
      </div>
    </div>
  </div>

  <!-- Spinner + Toast -->
  <div class="spinner" id="spinner"><div class="ring"></div></div>
  <div class="toast" id="toast"></div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTRwAjNAQxiPP8uR15t_vx03JkjgEBjgUwp2bpx8rsHx-JJxVDBZyf5ap77rAKrYHfgkVMwLJVm6pGn/pub?output=csv";
  const API_URL   = "https://script.google.com/macros/s/AKfycbzFfKy1GrenxyM7rqFiERG8AqwXNLLZ6Lj47l4XntYHHfD50EuXzcXca0zeFreRZGnJQw/exec";

  // === KEEP all your JS exactly as you pasted (normalizeRow, parseCsv, filters, charts, sorting, pagination, modal, etc.) ===
  // The only addition is below:

  // --- Edit Issue handler ---
  const editBtn = document.getElementById('editBtn');
  editBtn.addEventListener('click', async () => {
    if (!selectedIssue) return;
    const password = prompt("Enter password:");
    if (!password) return;
    const newStatus = prompt("New Status:", selectedIssue.status);
    if (newStatus === null) return;
    const newLog = prompt("New Log:", selectedIssue.log);
    if (newLog === null) return;

    try {
      showSpinner(true);
      const res = await fetch(API_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          password,
          id: selectedIssue.id,
          status: newStatus,
          log: newLog
        })
      });
      const json = await res.json();
      if (json.success) {
        showToast("‚úÖ Issue updated successfully");
        await loadSheet();
        closeModal();
      } else {
        showToast("‚ùå Update failed: " + (json.message || "error"));
      }
    } catch (err) {
      showToast("Error: " + err.message);
    } finally {
      showSpinner(false);
    }
  });

});
</script>
</body>
</html>
