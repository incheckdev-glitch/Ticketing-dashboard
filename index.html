<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>InCheck Issues Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    :root {
      --bg:#0b1020; --card:#111935; --muted:#7d8ab3; --text:#e8edff;
      --accent:#4f8cff; --danger:#ef4444; --ok:#10b981; --warn:#f59e0b; --info:#3b82f6; --purple:#8b5cf6; --neutral:#6b7280;
    }
    :root[data-theme="light"] {
      --bg:#f8f9ff; --card:#ffffff; --muted:#555; --text:#111;
      --accent:#2563eb; --danger:#dc2626; --ok:#059669; --warn:#d97706; --info:#1d4ed8; --purple:#7c3aed; --neutral:#374151;
    }
    body{margin:0;font-family:Inter,sans-serif;background:var(--bg);color:var(--text)}
    header{display:flex;gap:8px;align-items:center;padding:12px 16px;position:sticky;top:0;background:var(--card);z-index:10;flex-wrap:wrap}
    header .title{font-weight:700;font-size:18px}
    .toolbar{margin-left:auto;display:flex;flex-wrap:wrap;gap:8px;align-items:flex-end}
    input,select,button{padding:6px 10px;border-radius:8px;font:inherit}
    button{cursor:pointer;font-weight:600}
    .toolbar label{display:flex;flex-direction:column;font-size:12px;color:var(--muted)}
    .toolbar select,.toolbar input[type="date"]{margin-top:2px}
    .container{padding:20px;max-width:1200px;margin:0 auto}
    .grid{display:grid;gap:16px}
    .grid.cols-4{grid-template-columns:repeat(4,1fr)}
    @media(max-width:900px){.grid.cols-4{grid-template-columns:repeat(2,1fr)}}
    @media(max-width:580px){.grid.cols-4{grid-template-columns:1fr}}
    .card{background:var(--card);border-radius:12px;padding:16px}
    .kpi{text-align:center;cursor:pointer}
    .kpi .label{font-size:12px;color:var(--muted);text-transform:uppercase}
    .kpi .value{font-size:22px;font-weight:700}
    .charts{display:grid;grid-template-columns:repeat(2,1fr);gap:16px;margin-top:16px}
    @media(max-width:900px){.charts{grid-template-columns:1fr}}
    table{width:100%;border-collapse:collapse;font-size:14px}
    th,td{padding:8px;border-bottom:1px solid #333}
    th{position:sticky;top:0;background:var(--card)}
    .table-wrap{max-height:400px;overflow:auto}
    .pill{padding:2px 8px;border-radius:12px;font-size:12px;font-weight:600;display:inline-block}
    .status-Resolved{background:var(--ok);color:#fff}
    .status-Under\ Development{background:var(--info);color:#fff}
    .status-Rejected{background:var(--danger);color:#fff}
    .status-On\ Hold{background:var(--warn);color:#000}
    .status-Not\ Started\ Yet{background:var(--neutral);color:#fff}
    .status-Sent{background:var(--purple);color:#fff}
    .priority-High{background:#f87171;color:#fff}
    .priority-Medium{background:#fbbf24;color:#000}
    .priority-Low{background:#34d399;color:#000}
    /* Modal */
    .modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.7);align-items:center;justify-content:center;z-index:100}
    .modal-content{background:var(--card);color:var(--text);padding:20px;border-radius:12px;max-width:700px;width:90%;max-height:90%;overflow:auto}
    .modal-close{float:right;cursor:pointer;font-weight:bold}
  </style>
</head>
<body>
  <header>
    <div class="title">InCheck Issues Dashboard</div>
    <div class="toolbar">
      <input id="searchInput" type="search" placeholder="Search issues..." />

      <label>Module
        <select id="moduleFilter"></select>
      </label>

      <label>Priority
        <select id="priorityFilter"></select>
      </label>

      <label>Status
        <select id="statusFilter"></select>
      </label>

      <label>Start Date
        <input type="date" id="startDateFilter">
      </label>

      <label>End Date
        <input type="date" id="endDateFilter">
      </label>

      <button id="refreshNow">Refresh</button>
      <button id="resetBtn">Reset</button>
      <a href="https://docs.google.com/forms/d/e/1FAIpQLScZBcjXHMzssdXADWcmBiQKurxxR6eHQ_qR7-JdDoUbZg78lw/viewform" target="_blank">
        <button id="newTicketBtn">➕ New Ticket</button>
      </a>
      <button id="themeToggle">🌙</button>
    </div>
  </header>

  <div class="container">
    <div class="grid cols-4" id="kpis"></div>
    <div class="charts">
      <div class="card"><canvas id="byModule"></canvas></div>
      <div class="card"><canvas id="byPriority"></canvas></div>
      <div class="card"><canvas id="byStatus"></canvas></div>
      <div class="card"><canvas id="byType"></canvas></div>
    </div>
    <div class="card" style="margin-top:16px">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <strong>Issues</strong><span id="rowCount"></span>
      </div>
      <div class="table-wrap">
        <table id="issuesTable">
          <thead><tr>
            <th>ID</th><th>Module</th><th>Title</th><th>Priority</th><th>Status</th><th>Date</th><th>Link</th>
          </tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Drill-down modal -->
  <div id="issueModal" class="modal"><div class="modal-content">
    <span class="modal-close" onclick="closeModal()">&times;</span>
    <div id="modalBody"></div>
  </div></div>

  <script>
    const SHEET_URL="https://docs.google.com/spreadsheets/d/e/2PACX-1vTRwAjNAQxiPP8uR15t_vx03JkjgEBjgUwp2bpx8rsHx-JJxVDBZyf5ap77rAKrYHfgkVMwLJVm6pGn/pub?output=csv";
    const els={
      tableBody:document.querySelector('#issuesTable tbody'),
      rowCount:document.getElementById('rowCount'),
      moduleFilter:document.getElementById('moduleFilter'),
      priorityFilter:document.getElementById('priorityFilter'),
      statusFilter:document.getElementById('statusFilter'),
      reset:document.getElementById('resetBtn'),
      refresh:document.getElementById('refreshNow'),
      kpis:document.getElementById('kpis'),
      modal:document.getElementById('issueModal'),
      modalBody:document.getElementById('modalBody')
    };
    let rows=[],filtered=[],charts={};

    function normalizeRow(raw){
      const lower={};
      for(const k in raw){
        if(!k) continue;
        const cleanKey = k.toLowerCase().replace(/\s+/g,' ').trim();
        lower[cleanKey] = String(raw[k] ?? '').trim();
      }
      const pick=(...keys)=>{ for(const key of keys){ if(lower[key.toLowerCase()]) return lower[key.toLowerCase()]; } return ''; };

      return {
        id: pick('ticket id','id'),
        module: pick('impacted module','module','issue location') || 'Unspecified',
        title: pick('title'),
        desc: pick('description'),
        file: pick('file upload','link','url'),
        priority: pick('priority'),
        status: pick('status') || 'Not Started Yet',
        type: pick('category','type'),
        date: pick('timestamp','date','created at')
      };
    }

    // ✅ Hard filter: drop rows where only Timestamp is filled
    function parseCsv(t){
      return Papa.parse(t,{header:true,skipEmptyLines:true}).data
        .map(normalizeRow)
        .filter(r => {
          const keys = ["id","title","module","desc","priority","status","type","file"];
          const hasRealField = keys.some(k => r[k] && r[k].trim() !== "" && r[k].trim() !== "Unspecified");
          return hasRealField; // must have at least one real field
        });
    }

    function pill(text,cls){return `<span class="pill ${cls}">${text||'-'}</span>`;}
    function statusBadge(s){return pill(s,`status-${s.replace(/\s/g,'\\ ')}`);}
    function priorityBadge(p){return pill(p,`priority-${p}`);}

    function renderKpis(){
      const total=filtered.length; const counts={};
      filtered.forEach(r=>{counts[r.status]=(counts[r.status]||0)+1;});
      els.kpis.innerHTML='';
      const add=(label,val)=>{
        const d=document.createElement('div');
        d.className='card kpi';
        d.innerHTML=`<div class="label">${label}</div><div class="value">${val}</div>`;
        d.onclick=()=>{ els.statusFilter.value=label; applyFilters(); };
        els.kpis.appendChild(d);
      };
      add('Total Issues',total);
      Object.entries(counts).forEach(([s,v])=>add(s,v));
    }

    function renderFilters(){
      let modules = rows.map(r => (r.module || "Unspecified").trim());
      const seenM=new Set();
      modules=modules.filter(m=>{const k=m.toLowerCase();if(seenM.has(k)) return false;seenM.add(k);return true;});
      modules.sort((a,b)=>a.toLowerCase().localeCompare(b.toLowerCase()));
      els.moduleFilter.innerHTML=['All',...modules].map(v=>`<option value="${v}">${v}</option>`).join('');

      let priorities = rows.map(r => (r.priority || "Unspecified").trim());
      const seenP=new Set();
      priorities=priorities.filter(p=>{const k=p.toLowerCase();if(seenP.has(k)) return false;seenP.add(k);return true;});
      priorities.sort((a,b)=>a.toLowerCase().localeCompare(b.toLowerCase()));
      els.priorityFilter.innerHTML=['All',...priorities].map(v=>`<option value="${v}">${v}</option>`).join('');

      let statuses = rows.map(r => (r.status || "Unspecified").trim());
      const seenS=new Set();
      statuses=statuses.filter(s=>{const k=s.toLowerCase();if(seenS.has(k)) return false;seenS.add(k);return true;});
      statuses.sort((a,b)=>a.toLowerCase().localeCompare(b.toLowerCase()));
      els.statusFilter.innerHTML=['All',...statuses].map(v=>`<option value="${v}">${v}</option>`).join('');
    }

    function renderTable(){
      els.tableBody.innerHTML=filtered.map(r=>`
        <tr onclick="openModal('${r.id}')">
          <td>${r.id||'-'}</td>
          <td>${r.module}</td>
          <td>${r.title||'-'}</td>
          <td>${priorityBadge(r.priority)}</td>
          <td>${statusBadge(r.status)}</td>
          <td>${r.date||'-'}</td>
          <td>${r.file?`<a href="${r.file}" target="_blank">🔗</a>`:'-'}</td>
        </tr>`).join('');
      els.rowCount.textContent=`${filtered.length} rows`;
    }

    function groupCount(list,key){return list.reduce((a,r)=>{const k=r[key]||'Unspecified';a[k]=(a[k]||0)+1;return a;},{});}
    function drawCharts(){
      const make=(id,type,data)=>{
        if(charts[id])charts[id].destroy();
        charts[id]=new Chart(document.getElementById(id),{
          type,
          data:{labels:Object.keys(data),datasets:[{data:Object.values(data)}]},
          options:{plugins:{legend:{display:type!=='bar'}}}
        });
      };
      make('byModule','bar',groupCount(filtered,'module'));
      make('byPriority','doughnut',groupCount(filtered,'priority'));
      make('byStatus','bar',groupCount(filtered,'status'));
      make('byType','bar',groupCount(filtered,'type'));
    }

    function applyFilters(){
      const q=(document.getElementById('searchInput').value||'').toLowerCase();
      const m=els.moduleFilter.value,p=els.priorityFilter.value,s=els.statusFilter.value;
      const start=document.getElementById('startDateFilter').value;
      const end=document.getElementById('endDateFilter').value;

      const startDate=start?new Date(start):null;
      const endDate=end?(()=>{let d=new Date(end);d.setDate(d.getDate()+1);return d;})():null;

      filtered=rows.filter(r=>{
        const hay=(r.id+' '+r.module+' '+(r.title||'')+' '+(r.desc||'')).toLowerCase();
        let keepDate=true; 
        if(r.date){
          const d=new Date(r.date);
          if(startDate && d<startDate) keepDate=false;
          if(endDate && d>=endDate) keepDate=false;
        } else if(startDate||endDate) keepDate=false;
        return (!q||hay.includes(q))
          &&(!m||m==='All'||(r.module||'Unspecified').trim()===m)
          &&(!p||p==='All'||(r.priority||'Unspecified').trim()===p)
          &&(!s||s==='All'||(r.status||'Unspecified').trim()===s)
          &&keepDate;
      });

      renderKpis();renderTable();drawCharts();
    }

    async function loadSheet(){
      const res=await fetch(SHEET_URL);
      const text=await res.text();
      rows=parseCsv(text);
      filtered=[...rows];
      renderFilters();applyFilters();
    }

    function openModal(id){
      const r=rows.find(x=>x.id===id);
      els.modalBody.innerHTML=`
        <h2>${r.title||'-'}</h2>
        <p><b>ID:</b> ${r.id||'-'}</p>
        <p><b>Module:</b> ${r.module}</p>
        <p><b>Priority:</b> ${r.priority||'-'}</p>
        <p><b>Status:</b> ${r.status||'-'}</p>
        <p><b>Date:</b> ${r.date||'-'}</p>
        <p><b>Description:</b> ${r.desc||'-'}</p>
        ${r.file?`<p><b>Attachment:</b> <a href="${r.file}" target="_blank">${r.file}</a></p>`:''}`;
      els.modal.style.display='flex';
    }
    function closeModal(){els.modal.style.display='none';}

    document.getElementById('searchInput').addEventListener('input',applyFilters);
    els.moduleFilter.addEventListener('change',applyFilters);
    els.priorityFilter.addEventListener('change',applyFilters);
    els.statusFilter.addEventListener('change',applyFilters);
    document.getElementById('startDateFilter').addEventListener('change',applyFilters);
    document.getElementById('endDateFilter').addEventListener('change',applyFilters);
    els.reset.onclick=()=>{document.getElementById('searchInput').value='';document.getElementById('startDateFilter').value='';document.getElementById('endDateFilter').value='';renderFilters();applyFilters();};
    els.refresh.onclick=loadSheet;
    loadSheet();

    const themeBtn=document.getElementById('themeToggle');
    if(localStorage.getItem('theme')){
      document.documentElement.setAttribute('data-theme',localStorage.getItem('theme'));
      themeBtn.textContent=localStorage.getItem('theme')==='light'?'🌙':'☀️';
    }
    themeBtn.addEventListener('click',()=>{
      const cur=document.documentElement.getAttribute('data-theme')||'dark';
      const next=cur==='dark'?'light':'dark';
      document.documentElement.setAttribute('data-theme',next);
      localStorage.setItem('theme',next);
      themeBtn.textContent=next==='light'?'🌙':'☀️';
    });
  </script>
</body>
</html>
