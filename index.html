<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>InCheck Issues Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    :root {
      --bg:#0b1020; --card:#111935; --muted:#7d8ab3; --text:#e8edff;
      --accent:#4f8cff; --accent-2:#8b5cf6; --danger:#ef4444; --ok:#10b981;
    }
    body.light {
      --bg:#f9fafb; --card:#ffffff; --muted:#6b7280; --text:#111827;
      --accent:#2563eb; --accent-2:#7c3aed; --danger:#dc2626; --ok:#059669;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; font-family:Inter,system-ui,Segoe UI,Roboto,sans-serif; background:var(--bg); color:var(--text); transition:background .3s,color .3s}
    header{display:flex; gap:12px; align-items:center; padding:20px 24px; position:sticky; top:0; backdrop-filter:saturate(140%) blur(8px); background:var(--bg); z-index:10; border-bottom:1px solid #1e2a58}
    header .title{font-weight:700; font-size:18px}
    .container{padding:20px 24px; max-width:1200px; margin:0 auto}
    .grid{display:grid; gap:16px}
    .grid.cols-4{grid-template-columns:repeat(4,minmax(0,1fr))}
    @media (max-width: 900px){ .grid.cols-4{grid-template-columns:repeat(2,1fr)} }
    @media (max-width: 580px){ .grid.cols-4{grid-template-columns:1fr} }
    .card{background:var(--card); border:1px solid #1e2a58; border-radius:16px; padding:16px; box-shadow:0 8px 30px rgba(0,0,0,.2); transition:background .3s,color .3s}
    .kpi{display:flex; flex-direction:column; gap:6px; cursor:pointer; transition:transform .15s}
    .kpi:hover{transform:scale(1.03)}
    .kpi .label{color:var(--muted); font-size:12px; text-transform:uppercase}
    .kpi .value{font-size:28px; font-weight:800}
    .toolbar{display:flex; flex-wrap:wrap; gap:8px}
    select, input[type="search"], button{background:var(--card); color:var(--text); border:1px solid #263564; border-radius:10px; padding:10px 12px; font:inherit; transition:background .3s,color .3s}
    button{cursor:pointer; font-weight:600}
    .status-pill{padding:2px 8px; border-radius:999px; font-size:12px; font-weight:600}
    .status-Resolved{background:var(--ok); color:#fff}
    .status-Under\ Development{background:var(--accent); color:#fff}
    .status-Rejected{background:var(--danger); color:#fff}
    .status-Not\ Started\ Yet{background:#6b7280; color:#fff}
    table{width:100%; border-collapse:collapse; font-size:14px}
    th,td{padding:10px 8px; border-bottom:1px solid #213065; vertical-align:top}
    th{position:sticky; top:0; background:var(--card); z-index:1; text-align:left}

    /* Modal */
    .modal{display:none; position:fixed; inset:0; background:rgba(0,0,0,.7); z-index:50; justify-content:center; align-items:center; padding:20px}
    .modal-content{background:var(--card); border-radius:12px; padding:10px; width:90%; max-width:800px; height:90%; display:flex; flex-direction:column}
    .modal-content iframe{flex:1; border:none; border-radius:8px}
    .modal-content button{align-self:flex-end; margin-bottom:8px}
  </style>
</head>
<body>
  <header>
    <div class="title">InCheck Issues Dashboard</div>
    <div style="margin-left:auto" class="toolbar">
      <input id="searchInput" type="search" placeholder="Search title / ID / module" />
      <select id="moduleFilter"></select>
      <select id="priorityFilter"></select>
      <select id="statusFilter"></select>
      <button id="refreshNow">Refresh</button>
      <button id="resetBtn">Reset</button>
      <button id="newTicketBtn">Create New Ticket</button>
      <button id="themeToggle">🌙</button>
    </div>
  </header>

  <div class="container">
    <div class="grid cols-4" id="kpis"></div>

    <div class="card" style="margin-top:16px">
      <table id="issuesTable">
        <thead><tr><th>ID</th><th>Module</th><th>Title</th><th>Priority</th><th>Status</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- Modal with embedded form -->
  <div id="formModal" class="modal">
    <div class="modal-content">
      <button onclick="closeModal()">✖ Close</button>
      <iframe src="https://docs.google.com/forms/d/e/1FAIpQLScZBcjXHMzssdXADWcmBiQKurxxR6eHQ_qR7-JdDoUbZg78lw/viewform?embedded=true"></iframe>
    </div>
  </div>

  <script>
    const SHEET_URL="https://docs.google.com/spreadsheets/d/e/2PACX-1vTRwAjNAQxiPP8uR15t_vx03JkjgEBjgUwp2bpx8rsHx-JJxVDBZyf5ap77rAKrYHfgkVMwLJVm6pGn/pub?output=csv";

    const els={
      kpis:document.getElementById('kpis'),
      tableBody:document.querySelector('#issuesTable tbody'),
      search:document.getElementById('searchInput'),
      moduleFilter:document.getElementById('moduleFilter'),
      priorityFilter:document.getElementById('priorityFilter'),
      statusFilter:document.getElementById('statusFilter'),
      reset:document.getElementById('resetBtn'),
      refreshNow:document.getElementById('refreshNow'),
      themeToggle:document.getElementById('themeToggle'),
      newTicketBtn:document.getElementById('newTicketBtn'),
      modal:document.getElementById('formModal')
    };

    let rows=[],filtered=[];

    function normalizeRow(raw){
      const lower={}; for(const k in raw){ if(!k) continue; lower[k.toLowerCase().trim()]=String(raw[k]??'').trim(); }
      const pick=(...keys)=>{ for(const key of keys){ if(lower[key] && lower[key].length) return lower[key]; } return ''; };
      return {
        id:pick('ticket id','id'),
        module:pick('impacted module','module'),
        title:pick('title'),
        desc:pick('description'),
        priority:pick('priority'),
        status:pick('status')||'Not Started Yet'
      };
    }

    function parseCsv(text){
      const parsed=Papa.parse(text,{header:true,skipEmptyLines:true});
      return (parsed.data||[]).map(normalizeRow).filter(r=>r.id||r.title);
    }

    function renderFilters(){
      const uniq=arr=>[...new Set(arr.filter(Boolean))].sort();
      els.moduleFilter.innerHTML=['All',...uniq(rows.map(r=>r.module))].map(v=>`<option>${v}</option>`).join('');
      els.priorityFilter.innerHTML=['All',...uniq(rows.map(r=>r.priority))].map(v=>`<option>${v}</option>`).join('');
      els.statusFilter.innerHTML=['All',...uniq(rows.map(r=>r.status))].map(v=>`<option>${v}</option>`).join('');
    }

    function renderKpis(){
      const counts={}; filtered.forEach(r=>{counts[r.status]=(counts[r.status]||0)+1;});
      els.kpis.innerHTML=`
        <div class="card kpi" data-filter="All"><div class="label">Total Issues</div><div class="value">${filtered.length}</div></div>
        ${Object.entries(counts).map(([s,n])=>`
          <div class="card kpi" data-filter="${s}">
            <div class="label">${s}</div><div class="value">${n}</div>
          </div>`).join('')}
      `;
      document.querySelectorAll('#kpis .card').forEach(card=>{
        card.onclick=()=>{
          const f=card.getAttribute('data-filter');
          els.statusFilter.value=f==='All'?'All':f;
          applyFilters();
        };
      });
    }

    function renderTable(){
      els.tableBody.innerHTML=filtered.map(r=>`
        <tr>
          <td>${r.id}</td>
          <td>${r.module}</td>
          <td>${r.title}</td>
          <td>${r.priority}</td>
          <td><span class="status-pill status-${r.status.replace(/\s+/g,' ')}">${r.status}</span></td>
        </tr>`).join('');
    }

    function applyFilters(){
      const q=(els.search.value||'').toLowerCase();
      const m=els.moduleFilter.value,p=els.priorityFilter.value,s=els.statusFilter.value;
      filtered=rows.filter(r=>{
        const text=(r.id+' '+r.module+' '+r.title).toLowerCase();
        return (!q||text.includes(q)) && (m==='All'||r.module===m) && (p==='All'||r.priority===p) && (s==='All'||r.status===s);
      });
      renderKpis(); renderTable();
    }

    async function loadSheet(){
      const res=await fetch(SHEET_URL+"&t="+Date.now());
      const text=await res.text();
      rows=parseCsv(text); filtered=[...rows];
      renderFilters(); applyFilters();
    }

    // Theme toggle
    function setTheme(mode){ document.body.classList.toggle('light',mode==='light'); localStorage.setItem('theme',mode); els.themeToggle.textContent=mode==='light'?'🌙':'☀️'; }
    els.themeToggle.onclick=()=>{ setTheme(document.body.classList.contains('light')?'dark':'light'); };
    setTheme(localStorage.getItem('theme')||'dark');

    // Modal controls
    els.newTicketBtn.onclick=()=>{ els.modal.style.display='flex'; };
    function closeModal(){ els.modal.style.display='none'; }
    window.closeModal=closeModal;

    els.search.addEventListener('input',applyFilters);
    els.moduleFilter.addEventListener('change',applyFilters);
    els.priorityFilter.addEventListener('change',applyFilters);
    els.statusFilter.addEventListener('change',applyFilters);
    els.reset.addEventListener('click',()=>{els.search.value='';renderFilters();applyFilters();});
    els.refreshNow.addEventListener('click',loadSheet);

    loadSheet();
  </script>
</body>
</html>
