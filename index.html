<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>InCheck Issues Dashboard</title>

  <!-- Libs -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    /* === KEEP your full CSS exactly as before (status colors, priorities, theme, layout, sidebar, table, modal, spinner, toast, etc.) === */
  </style>
</head>
<body>
  <header>
    <div class="brand"><div class="logo">IC</div><div>InCheck Issues</div></div>
    <button id="drawerBtn" class="btn drawer-toggle">üß∞ Filters</button>
    <div class="toolbar">
      <input id="searchInput" class="input" type="search" placeholder="Search‚Ä¶" />
      <select id="themeSelect" class="select"><option value="system">System</option><option value="dark">Dark</option><option value="light">Light</option></select>
      <button id="refreshNow" class="btn">üîÑ Refresh</button>
      <button id="createTicketBtn" class="btn primary">‚ûï Create Ticket</button>
    </div>
  </header>

  <div class="wrap">
    <aside class="sidebar" id="sidebar">
      <!-- your filters markup unchanged -->
    </aside>

    <main class="content">
      <div class="grid cols-4" id="kpis"></div>
      <div class="charts">
        <div class="card"><canvas id="byModule"></canvas></div>
        <div class="card"><canvas id="byPriority"></canvas></div>
        <div class="card"><canvas id="byStatus"></canvas></div>
        <div class="card"><canvas id="byType"></canvas></div>
      </div>
      <div class="card">
        <div style="display:flex;justify-content:space-between;margin-bottom:8px">
          <strong>Issues</strong><span id="rowCount" class="muted"></span>
        </div>
        <div class="table-wrap">
          <table id="issuesTable">
            <thead><tr>
              <th data-key="id" class="sortable">ID</th>
              <th data-key="module" class="sortable">Module</th>
              <th data-key="title" class="sortable">Title</th>
              <th data-key="priority" class="sortable">Priority</th>
              <th data-key="status" class="sortable">Status</th>
              <th data-key="date" class="sortable">Date</th>
              <th data-key="log" class="sortable">Log</th>
              <th>Link</th>
            </tr></thead>
            <tbody><tr><td colspan="8" style="text-align:center">Loading‚Ä¶</td></tr></tbody>
          </table>
        </div>
        <div class="table-actions"><!-- pagination controls here --></div>
      </div>
    </main>
  </div>

  <!-- Modal -->
  <div id="issueModal" class="modal">
    <div class="modal-content">
      <div class="header">
        <h2 id="modalTitle">Issue</h2>
        <div class="actions">
          <button id="copyId" class="btn sm">üÜî Copy ID</button>
          <button id="copyLink" class="btn sm">üîó Copy Link</button>
          <button id="modalClose" class="modal-close">‚úï</button>
        </div>
      </div>
      <div id="modalBody"></div>
      <!-- üöÄ Edit button added -->
      <div style="margin-top:12px;display:flex;gap:8px">
        <button id="editBtn" class="btn primary">‚úèÔ∏è Edit Issue</button>
      </div>
    </div>
  </div>

  <div class="spinner" id="spinner"><div class="ring"></div></div>
  <div class="toast" id="toast"></div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTRwAjNAQxiPP8uR15t_vx03JkjgEBjgUwp2bpx8rsHx-JJxVDBZyf5ap77rAKrYHfgkVMwLJVm6pGn/pub?output=csv";
  const API_URL   = "https://script.google.com/macros/s/AKfycbzFfKy1GrenxyM7rqFiERG8AqwXNLLZ6Lj47l4XntYHHfD50EuXzcXca0zeFreRZGnJQw/exec";

  const els = { tableBody: document.querySelector('#issuesTable tbody'),
    modal: q('#issueModal'), modalBody:q('#modalBody'), modalTitle:q('#modalTitle'),
    copyId:q('#copyId'), copyLink:q('#copyLink'), closeModal:q('#modalClose'),
    spinner:q('#spinner'), toast:q('#toast'), editBtn:q('#editBtn') };

  let rows=[], filtered=[], selectedIssue=null;
  function q(s){return document.querySelector(s);}
  function showToast(msg){els.toast.textContent=msg;els.toast.style.display='block';setTimeout(()=>els.toast.style.display='none',3000);}
  function showSpinner(v=true){els.spinner.style.display=v?'flex':'none';}

  function normalizeRow(raw){const lower={};for(const k in raw){if(!k)continue;lower[k.toLowerCase().trim()]=String(raw[k]||'').trim();}
    return {id:lower['ticket id']||lower['id'], module:lower['module'], title:lower['title'], desc:lower['description'], file:lower['link'], priority:lower['priority'], status:lower['status'], date:lower['date'], log:lower['log']};}
  function parseCsv(t){return Papa.parse(t,{header:true,skipEmptyLines:true}).data.map(normalizeRow).filter(r=>r.id);}
  async function loadSheet(){showSpinner(true);const res=await fetch(SHEET_URL);const text=await res.text();rows=parseCsv(text);filtered=[...rows];renderTable();showSpinner(false);}
  function renderTable(){els.tableBody.innerHTML=filtered.map(r=>`<tr data-id="${r.id}"><td>${r.id}</td><td>${r.module}</td><td>${r.title}</td><td>${r.priority}</td><td>${r.status}</td><td>${r.date}</td><td>${r.log}</td><td>${r.file?`<a href="${r.file}" target="_blank">üîó</a>`:''}</td></tr>`).join('');}

  function openModal(id){selectedIssue=rows.find(x=>x.id===id);if(!selectedIssue)return;els.modalTitle.textContent=selectedIssue.title;els.modalBody.innerHTML=`<p><b>ID:</b> ${selectedIssue.id}</p><p><b>Status:</b> ${selectedIssue.status}</p><p><b>Log:</b> ${selectedIssue.log}</p>`;els.modal.style.display='flex';}
  function closeModal(){els.modal.style.display='none';selectedIssue=null;}
  els.closeModal.addEventListener('click',closeModal);
  els.tableBody.addEventListener('click',e=>{const tr=e.target.closest('tr[data-id]');if(tr)openModal(tr.dataset.id);});

  // üöÄ Edit handler
  els.editBtn.addEventListener('click', async ()=>{
    if(!selectedIssue)return;
    const password=prompt("Enter password:"); if(!password)return;
    const newStatus=prompt("New Status:",selectedIssue.status); if(newStatus===null)return;
    const newLog=prompt("New Log:",selectedIssue.log); if(newLog===null)return;
    try{showSpinner(true);
      const res=await fetch(API_URL,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({password,id:selectedIssue.id,status:newStatus,log:newLog})});
      const json=await res.json();
      if(json.success){showToast("‚úÖ Issue updated");await loadSheet();closeModal();}
      else{showToast("‚ùå Failed: "+(json.message||''));}
    }catch(err){showToast("Error: "+err.message);}finally{showSpinner(false);}
  });

  loadSheet();
});
</script>
</body>
</html>

