<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>InCheck Issues Dashboard</title>

  <!-- Libs -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    :root { --bg:#0b1020; --card:#0f1630; --muted:#9aa6d1; --text:#e8edff;
      --accent:#4f8cff; --danger:#ef4444; --ok:#10b981; --warn:#f59e0b;
      --info:#3b82f6; --purple:#8b5cf6; --neutral:#6b7280; --border:#1e2643;
      --shadow:0 8px 24px rgba(0,0,0,.35); }
    :root[data-theme="light"] { --bg:#f4f6ff; --card:#ffffff; --muted:#5a678c; --text:#0d1326;
      --accent:#2563eb; --danger:#dc2626; --ok:#059669; --warn:#d97706;
      --info:#1d4ed8; --purple:#7c3aed; --neutral:#374151; --border:#e7eaf6;
      --shadow:0 10px 24px rgba(16,24,40,.08); }
    body { margin:0; font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;
      background:var(--bg); color:var(--text); }
    header { position:sticky; top:0; z-index:20; background:var(--card);
      border-bottom:1px solid var(--border); display:flex; align-items:center;
      gap:12px; padding:10px 16px; box-shadow:var(--shadow); }
    .brand { display:flex; align-items:center; gap:10px; font-weight:700; }
    .brand .logo { width:28px; height:28px; border-radius:8px; display:grid; place-items:center;
      background:linear-gradient(135deg,var(--accent),#9b8cff); color:#fff; font-weight:800; }
    .toolbar { margin-left:auto; display:flex; gap:10px; align-items:center; flex-wrap:wrap }
    .btn, .select, .input { padding:8px 12px; border-radius:10px; border:1px solid var(--border);
      background:transparent; color:inherit; font:inherit; }
    .btn { cursor:pointer; font-weight:600; background:var(--card) }
    .btn.primary { background:var(--accent); border-color:transparent; color:#fff }
    .btn:hover { opacity:.92; transform:translateY(-1px) }
    .icon { font-size:18px; line-height:1 }
    .wrap { display:grid; grid-template-columns:280px 1fr; gap:18px; padding:18px; max-width:1400px; margin:0 auto }
    @media(max-width:980px){ .wrap { grid-template-columns:1fr } }
    .sidebar { background:var(--card); border:1px solid var(--border); border-radius:14px; padding:16px; }
    .content { display:grid; gap:18px }
    .grid { display:grid; gap:16px }
    .grid.cols-4 { grid-template-columns:repeat(4,1fr) }
    @media(max-width:980px){ .grid.cols-4{ grid-template-columns:repeat(2,1fr) } }
    @media(max-width:600px){ .grid.cols-4{ grid-template-columns:1fr } }
    .card { background:var(--card); border:1px solid var(--border); border-radius:14px; padding:16px; box-shadow:var(--shadow); }
    table { width:100%; border-collapse:separate; border-spacing:0; font-size:14px }
    thead th { position:sticky; top:0; background:var(--card); text-align:left; padding:12px 10px; border-bottom:1px solid var(--border); cursor:pointer; }
    tbody td { padding:11px 10px; border-bottom:1px solid var(--border) }
    tr:hover { background:rgba(255,255,255,.03) }
    .pill { padding:2px 8px; border-radius:12px; font-size:12px; font-weight:700; display:inline-block }
    .status-Resolved{background:var(--ok);color:#fff}
    .priority-High{background:#f87171;color:#fff}
    .priority-Medium{background:#fbbf24;color:#000}
    .priority-Low{background:#34d399;color:#000}
    .spinner { display:none; position:fixed; inset:0; background:rgba(0,0,0,.35); z-index:120; align-items:center; justify-content:center }
    .spinner .ring { width:54px; height:54px; border:5px solid var(--border); border-top-color:var(--accent); border-radius:50%; animation:spin 1s linear infinite; }
    @keyframes spin { to { transform:rotate(360deg) } }
    .toast { position:fixed; right:16px; bottom:16px; background:var(--card); border:1px solid var(--danger); color:#fff; padding:10px 12px; border-radius:10px; z-index:130; display:none }
  </style>
</head>
<body>
  <header>
    <div class="brand"><div class="logo">IC</div><div>InCheck Issues</div></div>
    <div class="toolbar">
      <input id="searchInput" class="input" type="search" placeholder="Searchâ€¦" />
      <button id="refreshNow" class="btn"><span class="icon">ðŸ”„</span> Refresh</button>
      <button id="exportBtn" class="btn"><span class="icon">â¬‡</span> Export CSV</button>
      <button id="newTicketBtn" class="btn primary"><span class="icon">âž•</span> New Ticket</button>
    </div>
  </header>

  <div class="wrap">
    <main class="content">
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
          <strong>Issues</strong>
          <span id="rowCount" class="muted"></span>
        </div>
        <div class="table-wrap">
          <table id="issuesTable">
            <thead><tr>
              <th>ID</th><th>Module</th><th>Title</th><th>Priority</th><th>Status</th><th>Date</th><th>Log</th>
            </tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </main>
  </div>

  <div class="spinner" id="spinner"><div class="ring"></div></div>
  <div class="toast" id="toast"></div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const SHEET_URL = "PUT_YOUR_SHEET_PUBLISHED_CSV_URL_HERE";
  const FORM_URL = "PUT_YOUR_GOOGLE_FORM_URL_HERE";

  const els = {
    tableBody: document.querySelector('#issuesTable tbody'),
    rowCount: document.querySelector('#rowCount'),
    refresh: document.querySelector('#refreshNow'),
    exportBtn: document.querySelector('#exportBtn'),
    newTicket: document.querySelector('#newTicketBtn'),
    spinner: document.querySelector('#spinner'),
    toast: document.querySelector('#toast')
  };

  let rows = [], filtered = [];

  const showSpinner = (v=true)=> els.spinner.style.display = v ? 'flex' : 'none';
  const showToast = (msg, ms=3500) => { els.toast.textContent = msg; els.toast.style.display = 'block'; setTimeout(()=>els.toast.style.display='none', ms); };

  function normalizeRow(raw){
    const lower={}; for(const k in raw){ if(!k) continue; lower[k.toLowerCase().trim()]=String(raw[k]??'').trim(); }
    return {
      id: lower['id'] || lower['ticket id'] || '',
      module: lower['module'] || '',
      title: lower['title'] || '',
      priority: lower['priority'] || '',
      status: lower['status'] || '',
      date: lower['date'] || lower['timestamp'] || '',
      log: lower['log'] || ''
    };
  }

  function renderTable(){
    els.tableBody.innerHTML = filtered.map(r=>`
      <tr>
        <td>${r.id}</td>
        <td>${r.module}</td>
        <td>${r.title}</td>
        <td><span class="pill priority-${r.priority}">${r.priority}</span></td>
        <td><span class="pill status-${r.status}">${r.status}</span></td>
        <td>${r.date}</td>
        <td>${r.log}</td>
      </tr>`).join('');
    els.rowCount.textContent = `${filtered.length} rows`;
  }

  async function loadSheet(){
    try {
      showSpinner(true);
      const res = await fetch(SHEET_URL, { cache:'no-store' });
      if(!res.ok) throw new Error(`Failed to fetch (${res.status})`);
      const text = await res.text();
      const data = Papa.parse(text,{header:true,skipEmptyLines:true}).data;
      rows = data.map(normalizeRow).filter(r=>r.id || r.title);
      console.log("Parsed rows:", rows); // DEBUG
      filtered = [...rows];
      renderTable();
    } catch(e) {
      showToast('Error loading data: '+e.message);
      els.tableBody.innerHTML = `<tr><td colspan="7" style="color:#ffb4b4">Error loading data.</td></tr>`;
    } finally {
      showSpinner(false);
    }
  }

  function exportCsv(){
    if(!filtered.length){ showToast('No data to export'); return; }
    const csv = Papa.unparse(filtered);
    const blob = new Blob([csv], {type:"text/csv"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url; a.download = "issues_export.csv";
    document.body.appendChild(a); a.click(); document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }

  // Events
  els.refresh.addEventListener('click', loadSheet);
  els.exportBtn.addEventListener('click', exportCsv);
  els.newTicket.addEventListener('click', ()=> window.open(FORM_URL, "_blank"));

  loadSheet();
});
</script>
</body>
</html>
