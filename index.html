<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>InCheck Issues Dashboard</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    :root {
      --bg:#0b1020; --card:#111935; --muted:#7d8ab3; --text:#e8edff;
      --accent:#4f8cff; --danger:#ef4444; --ok:#10b981; --warn:#f59e0b; --info:#3b82f6;
    }
    [data-theme="light"] {
      --bg:#f6f8fc; --card:#fff; --muted:#555; --text:#111;
      --accent:#365dc7; --danger:#dc2626; --ok:#16a34a; --warn:#d97706; --info:#2563eb;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,sans-serif;background:var(--bg);color:var(--text)}
    header{display:flex;gap:12px;align-items:center;padding:16px 20px;position:sticky;top:0;background:var(--card);z-index:10;border-bottom:1px solid #ccc}
    header .title{font-weight:700;font-size:18px}
    .toolbar{display:flex;flex-wrap:wrap;gap:8px;margin-left:auto}
    select,input[type="search"],button{background:var(--card);color:var(--text);border:1px solid #999;border-radius:8px;padding:8px 10px;font:inherit}
    button{cursor:pointer;font-weight:600}
    button.primary{background:var(--accent);color:#fff;border:none}
    button.secondary{background:transparent;border:1px solid var(--accent)}
    button.ghost{background:transparent;border:none}
    .container{padding:20px;max-width:1200px;margin:0 auto}
    .grid{display:grid;gap:16px}
    .grid.cols-4{grid-template-columns:repeat(4,minmax(0,1fr))}
    @media(max-width:900px){.grid.cols-4{grid-template-columns:repeat(2,1fr)}}
    @media(max-width:580px){.grid.cols-4{grid-template-columns:1fr}}
    .card{background:var(--card);border-radius:12px;padding:16px;box-shadow:0 2px 6px rgba(0,0,0,.1)}
    .kpi{cursor:pointer;text-align:center}
    .kpi .label{font-size:12px;color:var(--muted);text-transform:uppercase}
    .kpi .value{font-size:24px;font-weight:700}
    .charts{display:grid;grid-template-columns:repeat(2,1fr);gap:16px;margin-top:16px}
    @media(max-width:900px){.charts{grid-template-columns:1fr}}
    table{width:100%;border-collapse:collapse;font-size:14px}
    th,td{padding:8px;border-bottom:1px solid #ccc}
    th{background:var(--card);position:sticky;top:0;text-align:left}
    .table-wrap{max-height:400px;overflow:auto}
    .pill{padding:2px 8px;border-radius:12px;font-size:12px;font-weight:600;display:inline-block}
    .pill.status-Resolved{background:var(--ok);color:#fff}
    .pill.status-Under\ Development{background:var(--info);color:#fff}
    .pill.status-Rejected{background:var(--danger);color:#fff}
    .pill.status-On\ Hold{background:var(--warn);color:#fff}
    .pill.status-Not\ Started\ Yet{background:#6b7280;color:#fff}
    .pill.priority-High{background:#f87171;color:#fff}
    .pill.priority-Medium{background:#fbbf24;color:#000}
    .pill.priority-Low{background:#34d399;color:#000}
    /* Modal */
    .modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.6);align-items:center;justify-content:center;z-index:100}
    .modal-content{background:var(--card);color:var(--text);padding:20px;border-radius:12px;max-width:600px;width:90%;max-height:90%;overflow:auto}
    .modal-close{float:right;cursor:pointer;font-weight:bold}
    .dark-toggle{margin-left:8px}
  </style>
</head>
<body data-theme="dark">
  <header>
    <div class="title">InCheck Issues Dashboard</div>
    <div class="toolbar">
      <input id="searchInput" type="search" placeholder="Search issues..." />
      <select id="moduleFilter"></select>
      <select id="priorityFilter"></select>
      <select id="statusFilter"></select>
      <button id="refreshNow" class="secondary">Refresh</button>
      <button id="resetBtn" class="ghost">Reset</button>
      <button id="newTicketBtn" class="primary">Create New Ticket</button>
      <button id="themeToggle" class="secondary dark-toggle">üåô/‚òÄÔ∏è</button>
    </div>
  </header>

  <div class="container">
    <div class="grid cols-4" id="kpis"></div>
    <div class="charts">
      <div class="card"><canvas id="byModule"></canvas></div>
      <div class="card"><canvas id="byPriority"></canvas></div>
      <div class="card"><canvas id="byStatus"></canvas></div>
      <div class="card"><canvas id="byType"></canvas></div>
    </div>

    <div class="card" style="margin-top:16px">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <strong>Issues</strong>
        <span id="rowCount"></span>
      </div>
      <div class="table-wrap">
        <table id="issuesTable">
          <thead>
            <tr>
              <th>ID</th><th>Module</th><th>Title</th><th>Priority</th><th>Status</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Drill-down modal -->
  <div id="issueModal" class="modal"><div class="modal-content">
    <span class="modal-close" onclick="closeModal()">&times;</span>
    <div id="modalBody"></div>
  </div></div>

  <!-- Google Form modal -->
  <div id="formModal" class="modal"><div class="modal-content" style="width:95%;max-width:800px">
    <span class="modal-close" onclick="closeForm()">&times;</span>
    <iframe src="https://docs.google.com/forms/d/e/1FAIpQLScZBcjXHMzssdXADWcmBiQKurxxR6eHQ_qR7-JdDoUbZg78lw/viewform?embedded=true" width="100%" height="600" frameborder="0">Loading‚Ä¶</iframe>
  </div></div>

  <script>
    const SHEET_URL="https://docs.google.com/spreadsheets/d/e/2PACX-1vTRwAjNAQxiPP8uR15t_vx03JkjgEBjgUwp2bpx8rsHx-JJxVDBZyf5ap77rAKrYHfgkVMwLJVm6pGn/pub?output=csv";
    const els={tableBody:document.querySelector('#issuesTable tbody'),rowCount:document.getElementById('rowCount'),moduleFilter:document.getElementById('moduleFilter'),priorityFilter:document.getElementById('priorityFilter'),statusFilter:document.getElementById('statusFilter'),reset:document.getElementById('resetBtn'),refresh:document.getElementById('refreshNow'),kpis:document.getElementById('kpis'),modal:document.getElementById('issueModal'),modalBody:document.getElementById('modalBody'),formModal:document.getElementById('formModal')};
    let rows=[],filtered=[],charts={};

    function normalizeRow(raw){
      const lower={}; for(const k in raw){if(k)lower[k.toLowerCase().trim()]=String(raw[k]??'').trim();}
      const pick=(...keys)=>{for(const key of keys){if(lower[key])return lower[key];}return'';}
      return {id:pick('ticket id','id'),module:pick('impacted module','module'),title:pick('title'),desc:pick('description'),priority:pick('priority'),status:pick('status')||'Not Started Yet',type:pick('category','type')};
    }
    function parseCsv(t){return Papa.parse(t,{header:true,skipEmptyLines:true}).data.map(normalizeRow).filter(r=>r.id);}
    function badge(v,cls){return `<span class="pill ${cls}">${v||'-'}</span>`;}
    function statusBadge(s){return badge(s,`status-${s.replace(/\s/g,'\\ ')}`);}
    function priorityBadge(p){return badge(p,`priority-${p}`);}

    function renderKpis(){
      const total=filtered.length;
      const counts={};
      filtered.forEach(r=>{counts[r.status]=(counts[r.status]||0)+1;});
      els.kpis.innerHTML='';
      const add=(label,val)=>{const d=document.createElement('div');d.className='card kpi';d.innerHTML=`<div class="label">${label}</div><div class="value">${val}</div>`;d.onclick=()=>{els.statusFilter.value=label;applyFilters();};els.kpis.appendChild(d);}
      add('Total Issues',total);
      Object.entries(counts).forEach(([s,v])=>add(s,v));
    }

    function renderFilters(){
      const uniq=a=>[...new Set(a.filter(Boolean))].sort();
      els.moduleFilter.innerHTML=['All',...uniq(rows.map(r=>r.module))].map(v=>`<option>${v}</option>`).join('');
      els.priorityFilter.innerHTML=['All',...uniq(rows.map(r=>r.priority))].map(v=>`<option>${v}</option>`).join('');
      els.statusFilter.innerHTML=['All',...uniq(rows.map(r=>r.status))].map(v=>`<option>${v}</option>`).join('');
    }

    function renderTable(){
      els.tableBody.innerHTML=filtered.map(r=>`<tr onclick="openModal('${r.id}')"><td>${r.id}</td><td>${r.module}</td><td>${r.title}</td><td>${priorityBadge(r.priority)}</td><td>${statusBadge(r.status)}</td></tr>`).join('');
      els.rowCount.textContent=`${filtered.length} rows`;
    }

    function groupCount(list,key){return list.reduce((a,r)=>{const k=r[key]||'Unspecified';a[k]=(a[k]||0)+1;return a;},{});}
    function drawCharts(){
      const make=(id,type,data)=>{if(charts[id])charts[id].destroy();charts[id]=new Chart(document.getElementById(id),{type,data:{labels:Object.keys(data),datasets:[{data:Object.values(data)}]},options:{plugins:{legend:{display:type!=='bar'}}}});}
      make('byModule','bar',groupCount(filtered,'module'));
      make('byPriority','doughnut',groupCount(filtered,'priority'));
      make('byStatus','bar',groupCount(filtered,'status'));
      make('byType','bar',groupCount(filtered,'type'));
    }

    function applyFilters(){
      const q=(document.getElementById('searchInput').value||'').toLowerCase();
      const m=els.moduleFilter.value,p=els.priorityFilter.value,s=els.statusFilter.value;
      filtered=rows.filter(r=>{const txt=(r.id+' '+r.module+' '+r.title).toLowerCase();return(!q||txt.includes(q))&&(!m||m==='All'||r.module===m)&&(!p||p==='All'||r.priority===p)&&(!s||s==='All'||r.status===s);});
      renderKpis();renderTable();drawCharts();
    }

    async function loadSheet(){const res=await fetch(SHEET_URL);const text=await res.text();rows=parseCsv(text);filtered=[...rows];renderFilters();applyFilters();}
    function openModal(id){const r=rows.find(x=>x.id===id);els.modalBody.innerHTML=`<h2>${r.title}</h2><p><b>ID:</b> ${r.id}</p><p><b>Module:</b> ${r.module}</p><p><b>Priority:</b> ${r.priority}</p><p><b>Status:</b> ${r.status}</p><p><b>Description:</b> ${r.desc}</p>`;els.modal.style.display='flex';}
    function closeModal(){els.modal.style.display='none';}
    function closeForm(){els.formModal.style.display='none';}
    document.getElementById('newTicketBtn').onclick=()=>{els.formModal.style.display='flex';};
    document.getElementById('themeToggle').onclick=()=>{const b=document.body;b.dataset.theme=b.dataset.theme==='dark'?'light':'dark';};
    document.getElementById('searchInput').addEventListener('input',applyFilters);
    els.moduleFilter.addEventListener('change',applyFilters);els.priorityFilter.addEventListener('change',applyFilters);els.statusFilter.addEventListener('change',applyFilters);
    els.reset.onclick=()=>{document.getElementById('searchInput').value='';renderFilters();applyFilters();};
    els.refresh.onclick=loadSheet;
    loadSheet();
  </script>
</body>
</html>
